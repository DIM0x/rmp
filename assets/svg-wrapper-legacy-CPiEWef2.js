!function(){function e(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function t(t){for(var r=1;r<arguments.length;r++){var s=null!=arguments[r]?arguments[r]:{};r%2?e(Object(s),!0).forEach((function(e){n(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):e(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function n(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}System.register(["./chakra-legacy-DQqN9Dqk.js","./index-legacy-DJN3gwVR.js","./master-manager-legacy-D9dEF1LF.js","./react-legacy-BuT440iH.js","./useEvent-legacy-cmpNx-2-.js","./misc-nodes-legacy-zdGIoDpi.js"],(function(e,n){"use strict";var r,s,o,i,a,c,l,d,h,u,y,g,x,p,f,m,v,b,w,j,P,A,k,$,S,M,z,E,D,N,_,O,W,C,I,H,T,L,B,R,X,K,Y,U,V,F,q,J,Z,Q,G,ee,te,ne,re,se,oe;return{setters:[e=>{r=e.ad,s=e.j},e=>{o=e.n,i=e.ax,a=e.T,c=e.ay,l=e.az,d=e.a7,h=e.e,u=e.aA,y=e.aB,g=e.L,x=e.q,p=e.aC,f=e.aD,m=e.aE,v=e.aF,b=e.c,w=e.t,j=e.v,P=e.aG,A=e.aH,k=e.X,$=e.aI,S=e.aJ,M=e.o,z=e.p,E=e.r,D=e.E,N=e.x,_=e.y,O=e.D,W=e.Y,C=e.aK,I=e.aL,H=e.S,T=e.w,L=e.aM,B=e.a4,R=e.aN,X=e.af,K=e.G,Y=e.au,U=e.av,V=e.F,F=e.aO,q=e.d,J=e.a5},e=>{Z=e.s,Q=e.f,G=e.g,ee=e.i,te=e.b},e=>{ne=e.j,re=e.b},e=>{se=e.u},e=>{oe=e.m}],execute:function(){const n={[d.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[d.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},ie=ne("runtime/getStationNames",(async({cityName:e},{getState:t,dispatch:n,rejectWithValue:r})=>{const{token:s}=t().account;if(!s)return void n(c({cityName:e,names:[]}));const o=await fetch(`${l}/${e}`,{headers:{accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${s}`}});if(!o.ok)return a.warn("Failed to fetch random station names",o.statusText),r(o.statusText);const i=await o.json();n(c({cityName:e,names:i}))})),ae=ne("runtime/getOneStationName",(async(e,{getState:t,dispatch:r})=>{var s;const{stationNames:o}=t().runtime,i=o[e];if(0==(null!==(s=null==i?void 0:i.length)&&void 0!==s?s:0))return a.debug("No random station names in cache, using fallback"),r(ie({cityName:e})),Object.values((e=>{const t=n[e];return t.at(Math.floor(Math.random()*t.length))})(e));const l=structuredClone(i),d=l.shift();return r(c({cityName:e,names:l})),l.length<3&&r(ie({cityName:e})),Object.values(d)})),ce=re.memo((e=>{const{svgViewBoxMin:t,svgViewBoxZoom:n,svgWidth:o,svgHeight:i}=e,{preference:{toolsPanel:{expand:a}}}=h((e=>e.app)),c="light"===r().colorMode?"#666464":"#D3D3D4",l=u(t,n,o,i),d=a?410*n/100:0,g=n>30?n>120?50:25:5,x=n/200,p={startX:y(l.xMin+d-g,g),endX:y(l.xMax+d+g,g),startY:y(l.yMin-g,g),endY:y(l.yMax+g,g)},f=Array.from({length:(p.endX-p.startX)/g+1},((e,t)=>{const n=p.startX+t*g,r=n%(5*g)==0?2*x:x;return s.jsx("line",{x1:n,y1:p.startY,x2:n,y2:p.endY,strokeWidth:r,stroke:c,opacity:"0.5"},`grid_vl_${n}`)})),m=Array.from({length:(p.endY-p.startY)/g+1},((e,t)=>{const n=p.startY+t*g,r=n%(5*g)==0?2*x:x;return s.jsx("line",{x1:p.startX,y1:n,x2:p.endX,y2:n,strokeWidth:r,stroke:c,opacity:"0.5"},`grid_hl_${n}`)})),v=Array.from({length:(p.endX-p.startX)/g/5+1},((e,t)=>{const r=y(p.startX,5*g)+5*t*g;return s.jsx("text",{x:r,y:l.yMin+n/5,fontSize:25*x,fill:c,textAnchor:"middle",opacity:"0.5",children:r},`grid_vc_${r}`)})),b=Array.from({length:(p.endY-p.startY)/g/5+1},((e,t)=>{const r=y(p.startY,5*g)+5*t*g;return s.jsx("text",{x:l.xMin+n/8+d,y:r,fontSize:25*x,fill:c,textAnchor:"start",opacity:"0.5",children:r},`grid_hc_${r}`)}));return s.jsxs("g",{id:"grid-lines",className:"removeMe",children:[f,m,v,b]})}),((e,t)=>e.svgViewBoxMin.x===t.svgViewBoxMin.x&&e.svgViewBoxMin.y===t.svgViewBoxMin.y&&e.svgViewBoxZoom===t.svgViewBoxZoom&&e.svgWidth===t.svgWidth&&e.svgHeight===t.svgHeight)),le=(e,t,n,r,s,o)=>{if(!("offsetFrom"in o)||!("offsetTo"in o))return;if(Number.isNaN(o.offsetFrom)||Number.isNaN(o.offsetTo))return;if(o.offsetFrom===o.offsetTo)return he(e,t,n,r,s)?{x1:t,y1:n,x2:r,y2:s,offset:o.offsetFrom}:void 0;const[i,a]=[o.offsetFrom,o.offsetTo];for(let c=0;c<Math.PI;c+=Math.PI/8)for(let o=c,l=0;l<2;l++,o+=Math.PI){const[l,d,h,u]=[Math.sin(c)*i,Math.cos(c)*i,Math.sin(o)*a,Math.cos(o)*a];if(he(e,t+l,n+d,r+h,s+u))return{x1:t+l,y1:n+d,x2:r+h,y2:s+u,offset:0}}},de=(e,t,n,r,s,o)=>e===n?{x1:e+5*o,y1:t,x2:n+5*o,y2:r,offset:s}:t===r?{x1:e,y1:t+5*o,x2:n,y2:r+5*o,offset:s}:{x1:e+5*Math.SQRT1_2*o,y1:t+5*Math.SQRT1_2*o,x2:n+5*Math.SQRT1_2*o,y2:r+5*Math.SQRT1_2*o,offset:s},he=(e,t,n,r,s)=>!(t!==r&&n!==s||![g.Diagonal,g.Perpendicular].includes(e))||!(1!==Math.abs((s-n)/(r-t))||![g.Diagonal,g.RotatePerpendicular].includes(e)),ue=(e,t)=>{if(!t.every((t=>e.hasEdge(t))))return;const n=t.map((t=>{var n,r,s;const[o,i]=e.extremities(t),a=e.getNodeAttributes(o),c=e.getNodeAttributes(i),{type:l}=e.getEdgeAttributes(t),d=null!==(n=e.getEdgeAttribute(t,l))&&void 0!==n?n:x[l].defaultAttrs,h=le(l,a.x,a.y,c.x,c.y,d);if(h){const{x1:e,y1:t,x2:n,y2:r,offset:s}=h;return x[g.Simple].generatePath(e,n,t,r,{offset:s})}return null!==(r=null===(s=x[l])||void 0===s?void 0:s.generatePath(a.x,c.x,a.y,c.y,d))&&void 0!==r?r:`M ${a.x} ${a.y} L ${c.x} ${c.y}`}));let r=`${n[0]} `;for(let s=1;s<t.length;s+=1)r+=n[s].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return r},ye=e=>[...e.nodeEntries()].map((e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes})),ge=e=>{const t={},n={},r=[],s={},o=[];for(const l of e.edgeEntries()){const[e,t,r,s]=[l.sourceAttributes.x,l.sourceAttributes.y,l.targetAttributes.x,l.targetAttributes.y],o=l.attributes[l.attributes.type],i=le(l.attributes.type,e,t,r,s,o);n[l.edge]=i}for(const l of e.edgeEntries()){let i=n[l.edge];const{parallelIndex:a}=l.attributes;if(a>=0){const t=n[p(e,l.attributes.type,l.edge)];if(!t){r.push(l);continue}if(a>0){const{x1:e,y1:n,x2:r,y2:s,offset:o}=t;i=de(e,n,r,s,o,a)}}if(""===l.attributes.reconcileId)if(i){const e=l.edge,n=l.attributes,{x1:r,y1:s,x2:o,y2:a,offset:c}=i;t[e]={attr:n,path:x[g.Simple].generatePath(r,o,s,a,{offset:c})}}else o.push(l);else{const e=l.attributes.reconcileId;e in s?s[e].push(l):s[e]=[l]}}const i=new Set;for(;r.length;){const n=r.pop();if(i.has(n.edge))continue;const{parallel:s}=f(e,n);if(!s.length)continue;s.forEach((e=>i.add(e.edge)));const o=m(s);for(const e of s){const n=e.edge;t[n]={attr:e.attributes,path:o[n]}}}const{allReconciledLines:a,danglingLines:c}=((e,t)=>{const n=[],r=[];return Object.values(t).forEach((t=>{if(1===t.length)return void r.push(...t.map((e=>e.edge)));const s=e.getEdgeAttribute(t.at(0),"type");if(!t.every((t=>e.getEdgeAttribute(t,"type")===s)))return void r.push(...t.map((e=>e.edge)));const o=e.getEdgeAttribute(t.at(0),"style");if(!t.every((t=>e.getEdgeAttribute(t,"style")===o)))return void r.push(...t.map((e=>e.edge)));const i={},a=new Set,c=new Set,l=Object.fromEntries(t.map((t=>{var n,r;const[s,o]=e.extremities(t);return i[s]=(null!==(n=i[s])&&void 0!==n?n:0)+1,i[o]=(null!==(r=i[o])&&void 0!==r?r:0)+1,a.add(s),c.add(o),[s,[t.edge,o]]}))),d=Array.from(a).filter((e=>1===i[e])),h=Array.from(c).filter((e=>1===i[e]));if(1!==d.length||1!==h.length)return void r.push(...t.map((e=>e.edge)));const u=d[0],y=h[0];if(u===y)return void r.push(...t.map((e=>e.edge)));const g=[l[u][0]];let x=l[u][1];for(let e=1;e<t.length;e+=1){var p;const e=null===(p=l[x])||void 0===p?void 0:p.at(1);if(!e)return void r.push(...t.map((e=>e.edge)));g.push(l[x][0]),x=e}x===y&&g.length===t.length?n.push(g):r.push(...t.map((e=>e.edge)))})),{allReconciledLines:n,danglingLines:r}})(e,s);for(const l of a){const n=ue(e,l);if(!n)continue;const r=l[0];t[r]={attr:e.getEdgeAttributes(r),path:n}}for(const l of c){const n=e.getEdgeAttributes(l),[r,s]=e.extremities(l),o=e.getNodeAttributes(r),i=e.getNodeAttributes(s);t[l]={attr:n,path:x[g.Simple].generatePath(o.x,i.x,o.y,i.y,x[g.Simple].defaultAttrs)}}for(const l of o){const e=l.edge,n=l.attributes.type,r=l.attributes,[s,o,i,a]=[l.sourceAttributes.x,l.sourceAttributes.y,l.targetAttributes.x,l.targetAttributes.y];n in x?t[e]={attr:r,path:x[n].generatePath(s,i,o,a,r[n])}:t[e]={attr:r,path:`M ${s} ${o} L ${i} ${a}`}}return Object.entries(t).map((([e,t])=>({id:e,type:"line",line:t})))},xe=e=>{const{id:t,x:n,y:r,handlePointerDown:o,handlePointerMove:i,handlePointerUp:a}=e,c=re.useCallback((e=>o(t,e)),[t,o]),l=re.useCallback((e=>i(t,e)),[t,i]),d=re.useCallback((e=>a(t,e)),[t,a]);return s.jsx("g",{id:t,transform:`translate(${n-6.4} ${r-6.4})scale(0.025)`,onPointerDown:c,onPointerMove:l,onPointerUp:d,style:{cursor:"move"},children:s.jsx("path",{id:`stn_core_${t}`,fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},pe=e=>{const{id:t,path:n,handlePointerDown:r}=e,o=re.useCallback((e=>r(t,e)),[t,r]);return s.jsx("path",{id:t,d:n,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:o})},fe=re.memo((e=>{const{elements:t,handlePointerDown:n,handlePointerMove:r,handlePointerUp:o,handleEdgePointerDown:i}=e,a=Object.fromEntries(Array.from({length:21},((e,t)=>[t-10,{pre:[],main:[],post:[]}])));for(const w of t)if("line"===w.type){var c,l,d,h;const e=w.line.attr.type,t=w.line.attr.style,n=w.line.attr[t],r=null===(c=v[t])||void 0===c?void 0:c.preComponent;r&&a[w.line.attr.zIndex].pre.push(s.jsx(r,{id:w.id,type:e,path:w.line.path,styleAttrs:n,newLine:!1,handlePointerDown:i},`${w.id}.pre`));const o=null!==(l=null===(d=v[t])||void 0===d?void 0:d.component)&&void 0!==l?l:pe;a[w.line.attr.zIndex].main.push(s.jsx(o,{id:w.id,type:e,path:w.line.path,styleAttrs:n,newLine:!1,handlePointerDown:i},w.id));const u=null===(h=v[t])||void 0===h?void 0:h.postComponent;u&&a[w.line.attr.zIndex].post.push(s.jsx(u,{id:w.id,type:e,path:w.line.path,styleAttrs:n,newLine:!1,handlePointerDown:i},`${w.id}.post`))}else if("station"===w.type){var u,y,g,x;const e=w.station,t=e.type,i=null===(u=Z[t])||void 0===u?void 0:u.preComponent;i&&a[w.station.zIndex].pre.push(s.jsx(i,{id:w.id,x:e.x,y:e.y,attrs:e,handlePointerDown:n,handlePointerMove:r,handlePointerUp:o},`${w.id}.pre`));const c=null!==(y=null===(g=Z[t])||void 0===g?void 0:g.component)&&void 0!==y?y:xe;a[w.station.zIndex].main.push(s.jsx(c,{id:w.id,x:e.x,y:e.y,attrs:e,handlePointerDown:n,handlePointerMove:r,handlePointerUp:o},w.id));const l=null===(x=Z[t])||void 0===x?void 0:x.postComponent;l&&a[w.station.zIndex].post.push(s.jsx(l,{id:w.id,x:e.x,y:e.y,attrs:e,handlePointerDown:n,handlePointerMove:r,handlePointerUp:o},`${w.id}.post`))}else if("misc-node"===w.type){var p,f,m,b;const e=w.miscNode,t=e.type,i=null===(p=oe[t])||void 0===p?void 0:p.preComponent;i&&a[w.miscNode.zIndex].pre.push(s.jsx(i,{id:w.id,x:e.x,y:e.y,attrs:e[t],handlePointerDown:n,handlePointerMove:r,handlePointerUp:o},`${w.id}.pre`));const c=null!==(f=null===(m=oe[t])||void 0===m?void 0:m.component)&&void 0!==f?f:xe;a[w.miscNode.zIndex].main.push(s.jsx(c,{id:w.id,x:e.x,y:e.y,attrs:e[t],handlePointerDown:n,handlePointerMove:r,handlePointerUp:o},w.id));const l=null===(b=oe[t])||void 0===b?void 0:b.postComponent;l&&a[w.miscNode.zIndex].post.push(s.jsx(l,{id:w.id,x:e.x,y:e.y,attrs:e[t],handlePointerDown:n,handlePointerMove:r,handlePointerUp:o},`${w.id}.post`))}return Array.from({length:21},((e,t)=>(t-10).toString())).map((e=>[...a[e].pre,...a[e].main,...a[e].post])).flat()}),((e,t)=>e.elements===t.elements)),me=e=>{const{activeSnapPoint:t}=e,{svgViewBoxZoom:n}=h((e=>e.param)),{original:r,offset:o,rotate:i}=(e=>{const t=[{x:e.x,y:e.y},...e.originalNodesPos].sort(((e,t)=>e.x===t.x?e.y-t.y:e.x-t.x)),n=(t[1].y-t[0].y)/(t[1].x-t[0].x);if(Math.abs(n)<=.01)return{original:t,offset:t.map((e=>({x:e.x,y:e.y+10}))),rotate:0};if(Math.abs(n)>=1e10)return{original:t,offset:t.map((e=>({x:e.x+10,y:e.y}))),rotate:90};{const e=10,r=-1/n,s=e/Math.sqrt(r*r+1),o=e*r/Math.sqrt(r*r+1);return{original:t,offset:t.map((e=>({x:e.x+s,y:e.y+o}))),rotate:-Math.atan(r)*(180/Math.PI)}}})(t),a=e=>{const t=Math.sqrt(3)/2*e;return`0,0 ${`${-e/2},${t}`} ${`${e/2},${t}`}`},c=n/75,l=8*c,d="#FC8181",u=`${5*c} ${2*c}`;return s.jsxs(s.Fragment,{children:[s.jsx("line",{x1:o[0].x,y1:o[0].y,x2:o[1].x,y2:o[1].y,stroke:d,strokeWidth:c,strokeDasharray:u}),s.jsx("line",{x1:o[1].x,y1:o[1].y,x2:o[2].x,y2:o[2].y,stroke:d,strokeWidth:c,strokeDasharray:u}),s.jsx("line",{x1:r[0].x,y1:r[0].y,x2:o[0].x,y2:o[0].y,stroke:d,strokeWidth:c,strokeDasharray:u}),s.jsx("line",{x1:r[1].x,y1:r[1].y,x2:o[1].x,y2:o[1].y,stroke:d,strokeWidth:c,strokeDasharray:u}),s.jsx("line",{x1:r[2].x,y1:r[2].y,x2:o[2].x,y2:o[2].y,stroke:d,strokeWidth:c,strokeDasharray:u}),s.jsx("polygon",{points:a(l),transform:`translate(${o[0].x},${o[0].y}) rotate(${(i+270)%360})`,fill:d}),s.jsx("polygon",{points:a(l),transform:`translate(${o[1].x},${o[1].y}) rotate(${(i+270)%360})`,fill:d}),s.jsx("polygon",{points:a(l),transform:`translate(${o[1].x},${o[1].y}) rotate(${(i+90)%360})`,fill:d}),s.jsx("polygon",{points:a(l),transform:`translate(${o[2].x},${o[2].y}) rotate(${(i+90)%360})`,fill:d})]})},ve=[...Object.values(H),i.Virtual,i.Master,i.LondonArrow,i.ChongqingRTNumLineBadge2021,i.ChongqingRTTextLineBadge2021,i.ChengduRTLineBadge,i.GzmtrLineBadge],be=()=>{const e=b(),t=re.useRef(window.graph),{telemetry:{project:n},preference:{autoParallel:r,gridLines:i,snapLines:a}}=h((e=>e.app)),{svgViewBoxZoom:c,svgViewBoxMin:l}=h((e=>e.param)),{selected:d,refresh:{nodes:p,edges:f},mode:m,active:v,keepLastPath:H,theme:L}=h((e=>e.runtime)),B=w(),{height:R,width:X}=j(B),[K,Y]=re.useState(),[U,V]=re.useState({dx:0,dy:0}),[F,q]=re.useState([]),[J,ee]=re.useState([]),[te,ne]=re.useState([]);re.useEffect((()=>{if(K&&a)return;const e=u(l,c,X,R),n=Q(t.current,...Object.values(e));ee(n),q(G(t.current,n))}),[l,c,X,R,K]);const[ie,ae]=re.useState(void 0),ce=se(((t,n)=>{n.stopPropagation(),"select"===m&&e(P("free"));const r=n.currentTarget;A(n),r.setPointerCapture(n.pointerId),ne([]),ae(void 0),n.shiftKey?d.has(t)?e($(t)):e(S(t)):d.has(t)||e(k(new Set([t])))})),le=se(((e,t)=>{const{x:n,y:r}=A(t);m.startsWith("line")&&V({dx:(K.x-n)*c/100,dy:(K.y-r)*c/100})})),de=se(((s,i)=>{if(m.startsWith("line")){H||e(P("free"));const s=t.current.hasNode(v)&&ve.includes(t.current.getNodeAttribute(v,"type"));["stn_core_","virtual_circle_","misc_node_connectable_"].forEach((a=>{var c;const l=null===(c=document.elementsFromPoint(i.clientX,i.clientY)[0].attributes)||void 0===c||null===(c=c.getNamedItem("id"))||void 0===c?void 0:c.value,d=null==l?void 0:l.startsWith(a);if(s&&d){const s=m.slice(5),i=`line_${o(10)}`,[c,d]=[v,l.slice(a.length)],h=r?M(t.current,s,c,d,"from"):-1;t.current.addDirectedEdgeWithKey(i,c,d,{visible:!0,zIndex:0,type:s,[s]:structuredClone(x[s].defaultAttrs),style:z.SingleColor,[z.SingleColor]:{color:L},reconcileId:"",parallelIndex:h}),e(k(new Set([i]))),n&&E.event(D.ADD_LINE,{type:s})}})),e(N()),e(_(t.current.export()))}ne([]),ae(void 0),Y(void 0)})),he=se(((s,i)=>{if(i.stopPropagation(),i.shiftKey||e(O()),i.shiftKey&&d.has(s)?e($(s)):e(S(s)),m.startsWith("station")||m.startsWith("misc-node-virtual")||m.startsWith("misc-node-master")){const a=i.clientX-document.getElementById("canvas").getBoundingClientRect().left,d=i.clientY-document.getElementById("canvas").getBoundingClientRect().top,h=m.startsWith("station"),u=o(10),g=h?`stn_${u}`:`misc_node_${u}`,x=h?m.slice(8):m.slice(10),{x:p,y:f}=W(a,d,c,l),v=h?structuredClone(Z[x].defaultAttrs):structuredClone(oe[x].defaultAttrs);"color"in v&&(v.color=L),t.current.addNode(g,{visible:!0,zIndex:0,x:y(p,5),y:y(f,5),type:x,[x]:v});const b=t.current.getEdgeAttributes(s),{zIndex:w,type:j,style:A}=b,$=b[j],S=b[A],[M,z]=t.current.extremities(s),O=r?0:-1;t.current.addDirectedEdgeWithKey(`line_${o(10)}`,M,g,{visible:!0,zIndex:w,type:j,[j]:structuredClone($),style:A,[A]:structuredClone(S),reconcileId:"",parallelIndex:O}),t.current.addDirectedEdgeWithKey(`line_${o(10)}`,g,z,{visible:!0,zIndex:w,type:j,[j]:structuredClone($),style:A,[A]:structuredClone(S),reconcileId:"",parallelIndex:O}),t.current.dropEdge(s),e(T()),e(N()),e(_(t.current.export())),n&&(E.event(D.ADD_STATION,{type:x}),E.event(D.ADD_LINE,{type:j})),e(P("free")),e(k(new Set([g])))}})),ue=re.useMemo((()=>[...ge(t.current),...ye(t.current)]),[f,p]),xe=C.component;return s.jsxs(s.Fragment,{children:[s.jsx(fe,{elements:ue,handlePointerDown:ce,handlePointerMove:le,handlePointerUp:de,handleEdgePointerDown:he}),"/*",m.startsWith("line")&&v&&"background"!==v&&s.jsx(xe,{id:"line_create_in_progress___no_use",type:m.slice(5),path:x[m.slice(5)].generatePath(t.current.getNodeAttribute(v,"x"),t.current.getNodeAttribute(v,"x")-U.dx,t.current.getNodeAttribute(v,"y"),t.current.getNodeAttribute(v,"y")-U.dy,x[m.slice(5)].defaultAttrs),styleAttrs:{color:L},newLine:!0,handlePointerDown:()=>{}}),0!==te.length&&te.map((e=>s.jsx("path",{d:x[g.Simple].generatePath(...I(e,u(l,c,X,R)),x[g.Simple].defaultAttrs),stroke:"cyan",strokeWidth:c/75},`snap_line_${e.a}_${e.b}_${e.c}_${e.node}`))),"*/",ie&&s.jsx(me,{activeSnapPoint:ie})]})};e("default",(()=>{const e=b(),n=re.useRef(window.graph),r=()=>{e(T()),e(N()),e(_(n.current.export()))},{activeSubscriptions:a}=h((e=>e.account)),{telemetry:{project:c},preference:{randomStationsNames:l,gridLines:u}}=h((e=>e.app)),{svgViewBoxZoom:g,svgViewBoxMin:x}=h((e=>e.param)),{mode:p,lastTool:f,active:m,selected:v,keepLastPath:$,theme:S,refresh:{nodes:M},count:{masters:z,lines:C}}=h((e=>e.runtime)),I=w(),{height:H,width:G}=j(I),ne=!a.RMP_CLOUD&&z+1>L,ie=!a.RMP_CLOUD&&C+1>B,le=!a.RMP_CLOUD||"none"===l;R();const[de,he]=re.useState({x:0,y:0}),[ue,ye]=re.useState({x:0,y:0}),[ge,xe]=re.useState({x:0,y:0}),[pe,fe]=re.useState({x:0,y:0}),me=se((async s=>{const{x:i,y:a}=A(s);if(p.startsWith("station")||p.startsWith("misc-node")){e(P("free"));const s=o(10),{x:l,y:h}=W(i,a,g,x),u=p.startsWith("station"),f=u?`stn_${s}`:`misc_node_${s}`,m=u?p.slice(8):p.slice(10),v=structuredClone(t(t({},Z),oe)[m].defaultAttrs);if(q.has(m)&&(v.color=S),u&&!le){const t=v.names,n=await e(ae(d.Shmetro));if(ae.fulfilled.match(n)){const e=n.payload;t.length>e.length?e.push(...Array(t.length-e.length).fill(e.at(-1))):t.length<e.length&&e.splice(t.length,e.length-t.length),v.names=e}}n.current.addNode(f,{visible:!0,zIndex:0,x:y(l,5),y:y(h,5),type:m,[m]:v}),r(),c&&E.event(D.ADD_STATION,{type:m}),e(k(new Set([f])))}else"free"===p||p.startsWith("line")?(p.startsWith("line")&&(e(P("free")),$&&e(J(!1))),xe({x:i,y:a}),fe(x),s.shiftKey||(e(F("background")),e(O()))):"select"===p&&(he(W(i,a,g,x)),ye(W(i,a,g,x)))})),ve=se((t=>{if("select"===p){if(0!=de.x&&0!=de.y){const{x:e,y:n}=A(t);ye(W(e,n,g,x))}}else if("background"===m){const{x:n,y:r}=A(t);e(K({x:pe.x+(ge.x-n)*g/100,y:pe.y+(ge.y-r)*g/100}))}})),we=se((t=>{if("select"===p){const{x:r,y:s}=A(t),{x:o,y:i}=W(r,s,g,x),a=Q(n.current,de.x,de.y,o,i),c=te(n.current,new Set(a));e(k(new Set([...t.shiftKey?v:[],...a,...c]))),e(P("free")),he({x:0,y:0}),ye({x:0,y:0})}"background"!==m||t.shiftKey||e(F(void 0))})),je=se((t=>{let n=g;t.deltaY>0&&g+10<400?n=g+10:t.deltaY<0&&g-10>0&&(n=g-10),e(V(n));const{x:r,y:s}=A(t),o=t.currentTarget.getBoundingClientRect(),[i,a]=[r/o.width,s/o.height];e(K({x:x.x+r*g/100-G*n/100*i,y:x.y+s*g/100-H*n/100*a}))})),Pe=se((async t=>{if(X?"Backspace"===t.key:"Delete"===t.key)v.size>0&&(v.forEach((e=>{n.current.hasNode(e)?n.current.dropNode(e):n.current.hasEdge(e)&&n.current.dropEdge(e)})),e(O()),r());else if(t.key.startsWith("Arrow")){const n=100,r=t.key.endsWith("Left")?-1:t.key.endsWith("Right")?1:0,s=t.key.endsWith("Up")?-1:t.key.endsWith("Down")?1:0;e(K(W(n*r,n*s,g,x)))}else if("z"===t.key&&(X?t.metaKey&&!t.shiftKey:t.ctrlKey))X&&t.preventDefault(),e(Y()),e(T()),e(N());else if("s"===t.key)e(P("select"));else if("c"!==t.key&&"x"!==t.key||!(X?t.metaKey&&!t.shiftKey:t.ctrlKey))if("v"===t.key&&(X?t.metaKey&&!t.shiftKey:t.ctrlKey)){const t=await navigator.clipboard.readText(),{x:s,y:a}=W(G/2,H/2,g,x),{nodes:c,edges:l}=((e,t,n,r,s,a)=>{const{nodesWithAttrs:c,edgesWithAttrs:l,version:d}=JSON.parse(e);if(1!==d)throw Error(`Unrecognized version: ${d}`);const h={};Object.keys(c).filter((e=>t.hasNode(e))).forEach((e=>{const t=o(10);if(e.startsWith("stn_"))h[e]=`stn_${t}`;else{if(!e.startsWith("misc_node_"))throw Error(`Unrecognized node id: ${e}`);h[e]=`misc_node_${t}`}})),Object.keys(l).filter((e=>t.hasEdge(e))).forEach((e=>h[e]=`line_${o(10)}`));const u=Object.entries(h).reduce(((e,[t,n])=>e.replaceAll(t,n)),e),{nodesWithAttrs:y,edgesWithAttrs:g,avgX:x,avgY:p}=JSON.parse(u),f=n?Object.fromEntries(Object.entries(y).filter((([e,t])=>t.type!==i.Master))):y,m=n?Object.fromEntries(Object.entries(g).filter((([e,{source:t,target:n}])=>t in f&&n in f))):g;if(r)for(const o in m)m[o].attr.parallelIndex>=0&&(m[o].attr.parallelIndex=-1);const[v,b]=[s-x,a-p];return Object.entries(f).forEach((([e,n])=>{n.x+=v,n.y+=b,t.addNode(e,n)})),Object.entries(m).forEach((([e,{attr:n,source:r,target:s}])=>t.addDirectedEdgeWithKey(e,r,s,n))),{nodes:new Set(Object.keys(f)),edges:new Set(Object.keys(m))}})(t,n.current,ne,ie,y(s,5),y(a,5));r();const d=structuredClone(c);l.forEach((e=>d.add(e))),e(k(d))}else(X&&"z"===t.key&&t.metaKey&&t.shiftKey||!X&&"y"===t.key&&t.ctrlKey)&&(e(U()),e(T()),e(N()));else{const s=((e,t)=>{const n={},r={};let[s,o]=[0,0],i=0;t.forEach((t=>{if(e.hasNode(t)){const r=t,a=e.getNodeAttributes(r);n[r]=a,s+=a.x,o+=a.y,i++}else if(e.hasEdge(t)){const n=t,[s,o]=e.extremities(n);r[n]={attr:e.getEdgeAttributes(n),source:s,target:o}}}));const a={app:"rmp",version:1,nodesWithAttrs:n,edgesWithAttrs:r,avgX:s/i,avgY:o/i};return JSON.stringify(a)})(n.current,v);navigator.clipboard.writeText(s),"x"===t.key&&(e(O()),v.forEach((e=>{n.current.hasNode(e)?n.current.dropNode(e):n.current.hasEdge(e)&&n.current.dropEdge(e)})),r())}})),[Ae,ke]=re.useState(0),$e=se((t=>{if(2===t.touches.length){e(F(void 0));const[n,r]=[t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY];ke(n*n+r*r)}})),Se=se((t=>{if(0!==Ae&&2===t.touches.length){const[n,r]=[t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY],s=n*n+r*r;let o=g;s-Ae<0&&g+10<=390?o=g+10:s-Ae>0&&g-10>=10&&(o=g-10),e(V(o)),ke(s);const i=t.currentTarget.getBoundingClientRect(),[a,c]=[(t.touches[0].clientX+t.touches[1].clientX)/2-i.left,(t.touches[0].clientY+t.touches[1].clientY)/2-i.top],[l,d]=[a/i.width,c/i.height];e(K({x:x.x+a*g/100-G*o/100*l,y:x.y+c*g/100-H*o/100*d}))}})),Me=se((e=>{0!==Ae&&ke(0)})),[ze,Ee]=re.useState({sx:0,sy:0,ex:0,ey:0});return re.useEffect((()=>{Ee({sx:de.x<=ue.x?de.x:ue.x,ex:de.x>ue.x?de.x:ue.x,sy:de.y<=ue.y?de.y:ue.y,ey:de.y>ue.y?de.y:ue.y})}),[ue.x,ue.y]),s.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,userSelect:"none",touchAction:"none"},height:H,width:G,viewBox:`${x.x} ${x.y} ${G*g/100} ${H*g/100}`,onPointerDown:me,onPointerMove:ve,onPointerUp:we,onTouchStart:$e,onTouchMove:Se,onTouchEnd:Me,onWheel:je,tabIndex:0,onKeyDown:Pe,children:[u&&s.jsx(ce,{svgViewBoxMin:x,svgViewBoxZoom:g,svgWidth:G,svgHeight:H}),s.jsx(ee.SvgAssetsContextProvider,{children:s.jsx(be,{})}),"select"===p&&0!=de.x&&0!=de.y&&s.jsx("rect",{x:ze.sx,y:ze.sy,width:ze.ex-ze.sx,height:ze.ey-ze.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),s.jsx("defs",{children:s.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[s.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),s.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})}))}}}))}();
