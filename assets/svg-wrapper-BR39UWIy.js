import{ac as Vt,j as S}from"./chakra-C_7_uw7b.js";import{n as nt,ay as q,T as Bt,aA as Mt,aB as Ft,a8 as _t,e as G,aC as jt,aD as O,L as V,q as I,aE as Ut,aF as Gt,aG as Zt,Z as kt,c as Ot,t as Ht,v as Rt,aH as st,aI as et,X as rt,aJ as Lt,aK as $t,o as qt,p as zt,r as gt,E as pt,x as lt,y as Ct,D as xt,Y as J,aL as Jt,aM as Qt,S as te,w as mt,aN as ee,a5 as ne,aO as se,ag as tt,G as yt,av as oe,aw as ie,F as Dt,aP as Et,d as re,a6 as ae}from"./index-fVu3tKaK.js";import{s as dt,b as Xt,g as ce,i as le,c as de}from"./master-manager-Bm9DkXmO.js";import{j as Yt,d as $}from"./react-YtWR-Zuw.js";import{u as B}from"./useEvent-qDAdtkIH.js";import{m as ut}from"./misc-nodes-Xv2LN7F2.js";const ue=(t,e)=>{const h={},f={};let[o,c]=[0,0],x=0;e.forEach(d=>{if(t.hasNode(d)){const n=d,i=t.getNodeAttributes(n);h[n]=i,o+=i.x,c+=i.y,x++}else if(t.hasEdge(d)){const n=d,[i,g]=t.extremities(n);f[n]={attr:t.getEdgeAttributes(n),source:i,target:g}}});const l={app:"rmp",version:1,nodesWithAttrs:h,edgesWithAttrs:f,avgX:o/x,avgY:c/x};return JSON.stringify(l)},he=(t,e,h,f,o,c)=>{const{nodesWithAttrs:x,edgesWithAttrs:l,version:d}=JSON.parse(t);if(d!==1)throw Error("Unrecognized version: ".concat(d));const n={};Object.keys(x).filter(u=>e.hasNode(u)).forEach(u=>{const r=nt(10);if(u.startsWith("stn_"))n[u]="stn_".concat(r);else if(u.startsWith("misc_node_"))n[u]="misc_node_".concat(r);else throw Error("Unrecognized node id: ".concat(u))}),Object.keys(l).filter(u=>e.hasEdge(u)).forEach(u=>n[u]="line_".concat(nt(10)));const i=Object.entries(n).reduce((u,[r,v])=>u.replaceAll(r,v),t),{nodesWithAttrs:g,edgesWithAttrs:s,avgX:p,avgY:m}=JSON.parse(i),P=h?Object.fromEntries(Object.entries(g).filter(([u,r])=>r.type!==q.Master)):g,b=h?Object.fromEntries(Object.entries(s).filter(([u,{source:r,target:v}])=>r in P&&v in P)):s;if(f)for(const u in b)b[u].attr.parallelIndex>=0&&(b[u].attr.parallelIndex=-1);const[w,y]=[o-p,c-m];return Object.entries(P).forEach(([u,r])=>{r.x+=w,r.y+=y,e.addNode(u,r)}),Object.entries(b).forEach(([u,{attr:r,source:v,target:_}])=>e.addDirectedEdgeWithKey(u,v,_,r)),{nodes:new Set(Object.keys(P)),edges:new Set(Object.keys(b))}},fe={[_t.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[_t.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},ye=t=>{const e=fe[t];return e.at(Math.floor(Math.random()*e.length))},Nt=Yt("runtime/getStationNames",async({cityName:t},{getState:e,dispatch:h,rejectWithValue:f})=>{const{token:o}=e().account;if(!o){h(Mt({cityName:t,names:[]}));return}const c=await fetch("".concat(Ft,"/").concat(t),{headers:{accept:"application/json","Content-Type":"application/json",Authorization:"Bearer ".concat(o)}});if(!c.ok)return Bt.warn("Failed to fetch random station names",c.statusText),f(c.statusText);const x=await c.json();h(Mt({cityName:t,names:x}))}),Wt=Yt("runtime/getOneStationName",async(t,{getState:e,dispatch:h})=>{var l;const{stationNames:f}=e().runtime,o=f[t];if(((l=o==null?void 0:o.length)!=null?l:0)==0)return Bt.debug("No random station names in cache, using fallback"),h(Nt({cityName:t})),Object.values(ye(t));const c=structuredClone(o),x=c.shift();return h(Mt({cityName:t,names:c})),c.length<3&&h(Nt({cityName:t})),Object.values(x)}),ge=$.memo(t=>{const{svgViewBoxMin:e,svgViewBoxZoom:h,svgWidth:f,svgHeight:o}=t,{preference:{toolsPanel:{expand:c}}}=G(w=>w.app),l=Vt().colorMode==="light"?"#666464":"#D3D3D4",d=jt(e,h,f,o),n=c?410*h/100:0,i=h>30?h>120?50:25:5,g=h/200,s={startX:O(d.xMin+n-i,i),endX:O(d.xMax+n+i,i),startY:O(d.yMin-i,i),endY:O(d.yMax+i,i)},p=Array.from({length:(s.endX-s.startX)/i+1},(w,y)=>{const u=s.startX+y*i,r=u%(i*5)===0?2*g:g;return S.jsx("line",{x1:u,y1:s.startY,x2:u,y2:s.endY,strokeWidth:r,stroke:l,opacity:"0.5"},"grid_vl_".concat(u))}),m=Array.from({length:(s.endY-s.startY)/i+1},(w,y)=>{const u=s.startY+y*i,r=u%(i*5)===0?2*g:g;return S.jsx("line",{x1:s.startX,y1:u,x2:s.endX,y2:u,strokeWidth:r,stroke:l,opacity:"0.5"},"grid_hl_".concat(u))}),P=Array.from({length:(s.endX-s.startX)/i/5+1},(w,y)=>{const u=O(s.startX,5*i)+y*5*i;return S.jsx("text",{x:u,y:d.yMin+h/5,fontSize:g*25,fill:l,textAnchor:"middle",opacity:"0.5",children:u},"grid_vc_".concat(u))}),b=Array.from({length:(s.endY-s.startY)/i/5+1},(w,y)=>{const u=O(s.startY,5*i)+y*5*i;return S.jsx("text",{x:d.xMin+h/8+n,y:u,fontSize:g*25,fill:l,textAnchor:"start",opacity:"0.5",children:u},"grid_hc_".concat(u))});return S.jsxs("g",{id:"grid-lines",className:"removeMe",children:[p,m,P,b]})},(t,e)=>t.svgViewBoxMin.x===e.svgViewBoxMin.x&&t.svgViewBoxMin.y===e.svgViewBoxMin.y&&t.svgViewBoxZoom===e.svgViewBoxZoom&&t.svgWidth===e.svgWidth&&t.svgHeight===e.svgHeight),Kt=(t,e,h,f,o,c)=>{if(!("offsetFrom"in c)||!("offsetTo"in c)||Number.isNaN(c.offsetFrom)||Number.isNaN(c.offsetTo))return;if(c.offsetFrom===c.offsetTo)return It(t,e,h,f,o)?{x1:e,y1:h,x2:f,y2:o,offset:c.offsetFrom}:void 0;const[x,l]=[c.offsetFrom,c.offsetTo];for(let d=0;d<Math.PI;d+=Math.PI/8)for(let n=d,i=0;i<2;i++,n+=Math.PI){const[g,s,p,m]=[Math.sin(d)*x,Math.cos(d)*x,Math.sin(n)*l,Math.cos(n)*l];if(It(t,e+g,h+s,f+p,o+m))return{x1:e+g,y1:h+s,x2:f+p,y2:o+m,offset:0}}},pe=(t,e,h,f,o,c)=>t===h?{x1:t+5*c,y1:e,x2:h+5*c,y2:f,offset:o}:e===f?{x1:t,y1:e+5*c,x2:h,y2:f+5*c,offset:o}:{x1:t+5*Math.SQRT1_2*c,y1:e+5*Math.SQRT1_2*c,x2:h+5*Math.SQRT1_2*c,y2:f+5*Math.SQRT1_2*c,offset:o},It=(t,e,h,f,o)=>!!((e===f||h===o)&&[V.Diagonal,V.Perpendicular].includes(t)||Math.abs((o-h)/(f-e))===1&&[V.Diagonal,V.RotatePerpendicular].includes(t)),xe=(t,e)=>{const h=[],f=[];return Object.values(e).forEach(o=>{var w;if(o.length===1){f.push(...o.map(y=>y.edge));return}const c=t.getEdgeAttribute(o.at(0),"type");if(!o.every(y=>t.getEdgeAttribute(y,"type")===c)){f.push(...o.map(y=>y.edge));return}const x=t.getEdgeAttribute(o.at(0),"style");if(!o.every(y=>t.getEdgeAttribute(y,"style")===x)){f.push(...o.map(y=>y.edge));return}const l={},d=new Set,n=new Set,i=Object.fromEntries(o.map(y=>{var v,_;const[u,r]=t.extremities(y);return l[u]=((v=l[u])!=null?v:0)+1,l[r]=((_=l[r])!=null?_:0)+1,d.add(u),n.add(r),[u,[y.edge,r]]})),g=Array.from(d).filter(y=>l[y]===1),s=Array.from(n).filter(y=>l[y]===1);if(g.length!==1||s.length!==1){f.push(...o.map(y=>y.edge));return}const p=g[0],m=s[0];if(p===m){f.push(...o.map(y=>y.edge));return}const P=[i[p][0]];let b=i[p][1];for(let y=1;y<o.length;y=y+1){const u=(w=i[b])==null?void 0:w.at(1);if(!u){f.push(...o.map(r=>r.edge));return}P.push(i[b][0]),b=u}if(b!==m||P.length!==o.length){f.push(...o.map(y=>y.edge));return}h.push(P)}),{allReconciledLines:h,danglingLines:f}},me=(t,e)=>{if(!e.every(o=>t.hasEdge(o)))return;const h=e.map(o=>{var s,p,m;const[c,x]=t.extremities(o),l=t.getNodeAttributes(c),d=t.getNodeAttributes(x),{type:n}=t.getEdgeAttributes(o),i=(s=t.getEdgeAttribute(o,n))!=null?s:I[n].defaultAttrs,g=Kt(n,l.x,l.y,d.x,d.y,i);if(g){const{x1:P,y1:b,x2:w,y2:y,offset:u}=g;return I[V.Simple].generatePath(P,w,b,y,{offset:u})}return(m=(p=I[n])==null?void 0:p.generatePath(l.x,d.x,l.y,d.y,i))!=null?m:"M ".concat(l.x," ").concat(l.y," L ").concat(d.x," ").concat(d.y)});let f="".concat(h[0]," ");for(let o=1;o<e.length;o=o+1)f+=h[o].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return f},ve=t=>[...t.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),Se=t=>{const e={},h={},f=[],o={},c=[];for(const n of t.edgeEntries()){const[i,g,s,p]=[n.sourceAttributes.x,n.sourceAttributes.y,n.targetAttributes.x,n.targetAttributes.y],m=n.attributes[n.attributes.type],P=Kt(n.attributes.type,i,g,s,p,m);h[n.edge]=P}for(const n of t.edgeEntries()){let i=h[n.edge];const{parallelIndex:g}=n.attributes;if(g>=0){const s=Ut(t,n.attributes.type,n.edge),p=h[s];if(!p){f.push(n);continue}if(g>0){const{x1:m,y1:P,x2:b,y2:w,offset:y}=p;i=pe(m,P,b,w,y,g)}}if(n.attributes.reconcileId!==""){const s=n.attributes.reconcileId;s in o?o[s].push(n):o[s]=[n];continue}if(i){const s=n.edge,p=n.attributes,{x1:m,y1:P,x2:b,y2:w,offset:y}=i;e[s]={attr:p,path:I[V.Simple].generatePath(m,b,P,w,{offset:y})};continue}c.push(n)}const x=new Set;for(;f.length;){const n=f.pop();if(x.has(n.edge))continue;const{parallel:i}=Gt(t,n);if(!i.length)continue;i.forEach(s=>x.add(s.edge));const g=Zt(i);for(const s of i){const p=s.edge;e[p]={attr:s.attributes,path:g[p]}}}const{allReconciledLines:l,danglingLines:d}=xe(t,o);for(const n of l){const i=me(t,n);if(!i)continue;const g=n[0];e[g]={attr:t.getEdgeAttributes(g),path:i}}for(const n of d){const i=t.getEdgeAttributes(n),[g,s]=t.extremities(n),p=t.getNodeAttributes(g),m=t.getNodeAttributes(s);e[n]={attr:i,path:I[V.Simple].generatePath(p.x,m.x,p.y,m.y,I[V.Simple].defaultAttrs)}}for(const n of c){const i=n.edge,g=n.attributes.type,s=n.attributes,[p,m,P,b]=[n.sourceAttributes.x,n.sourceAttributes.y,n.targetAttributes.x,n.targetAttributes.y];if(!(g in I)){e[i]={attr:s,path:"M ".concat(p," ").concat(m," L ").concat(P," ").concat(b)};continue}e[i]={attr:s,path:I[g].generatePath(p,P,m,b,s[g])}}return Object.entries(e).map(([n,i])=>({id:n,type:"line",line:i}))},Tt=t=>{const{id:e,x:h,y:f,handlePointerDown:o,handlePointerMove:c,handlePointerUp:x}=t,l=$.useCallback(i=>o(e,i),[e,o]),d=$.useCallback(i=>c(e,i),[e,c]),n=$.useCallback(i=>x(e,i),[e,x]);return S.jsx("g",{id:e,transform:"translate(".concat(h-6.4," ").concat(f-6.4,")scale(0.025)"),onPointerDown:l,onPointerMove:d,onPointerUp:n,style:{cursor:"move"},children:S.jsx("path",{id:"stn_core_".concat(e),fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},be=t=>{const{id:e,path:h,handlePointerDown:f}=t,o=$.useCallback(c=>f(e,c),[e,f]);return S.jsx("path",{id:e,d:h,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:o})},Ae=$.memo(t=>{var d,n,i,g,s,p,m,P,b,w,y,u;const{elements:e,handlePointerDown:h,handlePointerMove:f,handlePointerUp:o,handleEdgePointerDown:c}=t,x=Object.fromEntries(Array.from({length:21},(r,v)=>[v-10,{pre:[],main:[],post:[]}]));for(const r of e)if(r.type==="line"){const v=r.line.attr.type,_=r.line.attr.style,T=r.line.attr[_],j=(d=kt[_])==null?void 0:d.preComponent;j&&x[r.line.attr.zIndex].pre.push(S.jsx(j,{id:r.id,type:v,path:r.line.path,styleAttrs:T,newLine:!1,handlePointerDown:c},"".concat(r.id,".pre")));const H=(i=(n=kt[_])==null?void 0:n.component)!=null?i:be;x[r.line.attr.zIndex].main.push(S.jsx(H,{id:r.id,type:v,path:r.line.path,styleAttrs:T,newLine:!1,handlePointerDown:c},r.id));const N=(g=kt[_])==null?void 0:g.postComponent;N&&x[r.line.attr.zIndex].post.push(S.jsx(N,{id:r.id,type:v,path:r.line.path,styleAttrs:T,newLine:!1,handlePointerDown:c},"".concat(r.id,".post")))}else if(r.type==="station"){const v=r.station,_=v.type,T=(s=dt[_])==null?void 0:s.preComponent;T&&x[r.station.zIndex].pre.push(S.jsx(T,{id:r.id,x:v.x,y:v.y,attrs:v,handlePointerDown:h,handlePointerMove:f,handlePointerUp:o},"".concat(r.id,".pre")));const j=(m=(p=dt[_])==null?void 0:p.component)!=null?m:Tt;x[r.station.zIndex].main.push(S.jsx(j,{id:r.id,x:v.x,y:v.y,attrs:v,handlePointerDown:h,handlePointerMove:f,handlePointerUp:o},r.id));const H=(P=dt[_])==null?void 0:P.postComponent;H&&x[r.station.zIndex].post.push(S.jsx(H,{id:r.id,x:v.x,y:v.y,attrs:v,handlePointerDown:h,handlePointerMove:f,handlePointerUp:o},"".concat(r.id,".post")))}else if(r.type==="misc-node"){const v=r.miscNode,_=v.type,T=(b=ut[_])==null?void 0:b.preComponent;T&&x[r.miscNode.zIndex].pre.push(S.jsx(T,{id:r.id,x:v.x,y:v.y,attrs:v[_],handlePointerDown:h,handlePointerMove:f,handlePointerUp:o},"".concat(r.id,".pre")));const j=(y=(w=ut[_])==null?void 0:w.component)!=null?y:Tt;x[r.miscNode.zIndex].main.push(S.jsx(j,{id:r.id,x:v.x,y:v.y,attrs:v[_],handlePointerDown:h,handlePointerMove:f,handlePointerUp:o},r.id));const H=(u=ut[_])==null?void 0:u.postComponent;H&&x[r.miscNode.zIndex].post.push(S.jsx(H,{id:r.id,x:v.x,y:v.y,attrs:v[_],handlePointerDown:h,handlePointerMove:f,handlePointerUp:o},"".concat(r.id,".post")))}return Array.from({length:21},(r,v)=>(v-10).toString()).map(r=>[...x[r].pre,...x[r].main,...x[r].post]).flat()},(t,e)=>t.elements===e.elements),we=t=>{const{activeSnapPoint:e}=t,{svgViewBoxZoom:h}=G(s=>s.param),f=s=>{const m=[{x:s.x,y:s.y},...s.originalNodesPos].sort((b,w)=>b.x===w.x?b.y-w.y:b.x-w.x),P=(m[1].y-m[0].y)/(m[1].x-m[0].x);if(Math.abs(P)<=.01)return{original:m,offset:m.map(b=>({x:b.x,y:b.y+10})),rotate:0};if(Math.abs(P)>=1e10)return{original:m,offset:m.map(b=>({x:b.x+10,y:b.y})),rotate:90};{const w=-1/P,y=10/Math.sqrt(w*w+1),u=10*w/Math.sqrt(w*w+1);return{original:m,offset:m.map(r=>({x:r.x+y,y:r.y+u})),rotate:-Math.atan(w)*(180/Math.PI)}}},{original:o,offset:c,rotate:x}=f(e),l=s=>{const p=Math.sqrt(3)/2*s,m="0,0",P="".concat(-s/2,",").concat(p),b="".concat(s/2,",").concat(p);return"".concat(m," ").concat(P," ").concat(b)},d=h/75,n=8*d,i="#FC8181",g="".concat(d*5," ").concat(d*2);return S.jsxs(S.Fragment,{children:[S.jsx("line",{x1:c[0].x,y1:c[0].y,x2:c[1].x,y2:c[1].y,stroke:i,strokeWidth:d,strokeDasharray:g}),S.jsx("line",{x1:c[1].x,y1:c[1].y,x2:c[2].x,y2:c[2].y,stroke:i,strokeWidth:d,strokeDasharray:g}),S.jsx("line",{x1:o[0].x,y1:o[0].y,x2:c[0].x,y2:c[0].y,stroke:i,strokeWidth:d,strokeDasharray:g}),S.jsx("line",{x1:o[1].x,y1:o[1].y,x2:c[1].x,y2:c[1].y,stroke:i,strokeWidth:d,strokeDasharray:g}),S.jsx("line",{x1:o[2].x,y1:o[2].y,x2:c[2].x,y2:c[2].y,stroke:i,strokeWidth:d,strokeDasharray:g}),S.jsx("polygon",{points:l(n),transform:"translate(".concat(c[0].x,",").concat(c[0].y,") rotate(").concat((x+270)%360,")"),fill:i}),S.jsx("polygon",{points:l(n),transform:"translate(".concat(c[1].x,",").concat(c[1].y,") rotate(").concat((x+270)%360,")"),fill:i}),S.jsx("polygon",{points:l(n),transform:"translate(".concat(c[1].x,",").concat(c[1].y,") rotate(").concat((x+90)%360,")"),fill:i}),S.jsx("polygon",{points:l(n),transform:"translate(".concat(c[2].x,",").concat(c[2].y,") rotate(").concat((x+90)%360,")"),fill:i})]})},Pe=[...Object.values(te),q.Virtual,q.Master,q.LondonArrow,q.ChongqingRTNumLineBadge2021,q.ChongqingRTTextLineBadge2021,q.ChengduRTLineBadge,q.GzmtrLineBadge],ke=()=>{const t=Ot(),e=$.useRef(window.graph),h=()=>{t(mt()),t(lt()),t(Ct(e.current.export()))},{telemetry:{project:f},preference:{autoParallel:o,gridLines:c,snapLines:x}}=G(k=>k.app),{svgViewBoxZoom:l,svgViewBoxMin:d}=G(k=>k.param),{selected:n,refresh:{nodes:i,edges:g},mode:s,active:p,keepLastPath:m,theme:P}=G(k=>k.runtime),b=Ht(),{height:w,width:y}=Rt(b),[u,r]=$.useState(),[v,_]=$.useState({dx:0,dy:0}),[T,j]=$.useState([]),[H,N]=$.useState([]),[ot,at]=$.useState([]);$.useEffect(()=>{if(u&&x)return;const k=jt(d,l,y,w),C=Xt(e.current,...Object.values(k));N(C),j(ce(e.current,C))},[d,l,y,w,u]);const[ht,ct]=$.useState(void 0),vt=B((k,C)=>{C.stopPropagation(),s==="select"&&t(st("free"));const F=C.currentTarget;et(C),F.setPointerCapture(C.pointerId),at([]),ct(void 0),C.shiftKey?n.has(k)?t(Lt(k)):t($t(k)):n.has(k)||t(rt(new Set([k])))}),St=B((k,C)=>{const{x:F,y:it}=et(C);s.startsWith("line")&&_({dx:(u.x-F)*l/100,dy:(u.y-it)*l/100})}),bt=B((k,C)=>{if(s.startsWith("line")){m||t(st("free"));const F=e.current.hasNode(p)&&Pe.includes(e.current.getNodeAttribute(p,"type"));["stn_core_","virtual_circle_","misc_node_connectable_"].forEach(Z=>{var A,E;const R=(E=(A=document.elementsFromPoint(C.clientX,C.clientY)[0].attributes)==null?void 0:A.getNamedItem("id"))==null?void 0:E.value,a=R==null?void 0:R.startsWith(Z);if(F&&a){const M=s.slice(5),z="line_".concat(nt(10)),[D,L]=[p,R.slice(Z.length)],W=o?qt(e.current,M,D,L,"from"):-1;e.current.addDirectedEdgeWithKey(z,D,L,{visible:!0,zIndex:0,type:M,[M]:structuredClone(I[M].defaultAttrs),style:zt.SingleColor,[zt.SingleColor]:{color:P},reconcileId:"",parallelIndex:W}),t(rt(new Set([z]))),f&&gt.event(pt.ADD_LINE,{type:M})}}),t(lt()),t(Ct(e.current.export()))}at([]),ct(void 0),r(void 0)}),At=B((k,C)=>{if(C.stopPropagation(),C.shiftKey||t(xt()),C.shiftKey&&n.has(k)?t(Lt(k)):t($t(k)),s.startsWith("station")||s.startsWith("misc-node-virtual")||s.startsWith("misc-node-master")){const F=C.clientX-document.getElementById("canvas").getBoundingClientRect().left,it=C.clientY-document.getElementById("canvas").getBoundingClientRect().top,Z=s.startsWith("station"),Y=nt(10),R=Z?"stn_".concat(Y):"misc_node_".concat(Y),a=Z?s.slice(8):s.slice(10),{x:A,y:E}=J(F,it,l,d),M=Z?structuredClone(dt[a].defaultAttrs):structuredClone(ut[a].defaultAttrs);"color"in M&&(M.color=P),e.current.addNode(R,{visible:!0,zIndex:0,x:O(A,5),y:O(E,5),type:a,[a]:M});const z=e.current.getEdgeAttributes(k),{zIndex:D,type:L,style:W}=z,K=z[L],U=z[W],[Q,ft]=e.current.extremities(k),X=o?0:-1;e.current.addDirectedEdgeWithKey("line_".concat(nt(10)),Q,R,{visible:!0,zIndex:D,type:L,[L]:structuredClone(K),style:W,[W]:structuredClone(U),reconcileId:"",parallelIndex:X}),e.current.addDirectedEdgeWithKey("line_".concat(nt(10)),R,ft,{visible:!0,zIndex:D,type:L,[L]:structuredClone(K),style:W,[W]:structuredClone(U),reconcileId:"",parallelIndex:X}),e.current.dropEdge(k),h(),f&&(gt.event(pt.ADD_STATION,{type:a}),gt.event(pt.ADD_LINE,{type:L})),t(st("free")),t(rt(new Set([R])))}}),wt=$.useMemo(()=>[...Se(e.current),...ve(e.current)],[g,i]),Pt=Jt.component;return S.jsxs(S.Fragment,{children:[S.jsx(Ae,{elements:wt,handlePointerDown:vt,handlePointerMove:St,handlePointerUp:bt,handleEdgePointerDown:At}),"/*",s.startsWith("line")&&p&&p!=="background"&&S.jsx(Pt,{id:"line_create_in_progress___no_use",type:s.slice(5),path:I[s.slice(5)].generatePath(e.current.getNodeAttribute(p,"x"),e.current.getNodeAttribute(p,"x")-v.dx,e.current.getNodeAttribute(p,"y"),e.current.getNodeAttribute(p,"y")-v.dy,I[s.slice(5)].defaultAttrs),styleAttrs:{color:P},newLine:!0,handlePointerDown:()=>{}}),ot.length!==0&&ot.map(k=>S.jsx("path",{d:I[V.Simple].generatePath(...Qt(k,jt(d,l,y,w)),I[V.Simple].defaultAttrs),stroke:"cyan",strokeWidth:l/75},"snap_line_".concat(k.a,"_").concat(k.b,"_").concat(k.c,"_").concat(k.node))),"*/",ht&&S.jsx(we,{activeSnapPoint:ht})]})},$e=()=>{const t=Ot(),e=$.useRef(window.graph),h=()=>{t(mt()),t(lt()),t(Ct(e.current.export()))},{activeSubscriptions:f}=G(a=>a.account),{telemetry:{project:o},preference:{randomStationsNames:c,gridLines:x}}=G(a=>a.app),{svgViewBoxZoom:l,svgViewBoxMin:d}=G(a=>a.param),{mode:n,lastTool:i,active:g,selected:s,keepLastPath:p,theme:m,refresh:{nodes:P},count:{masters:b,lines:w}}=G(a=>a.runtime),y=Ht(),{height:u,width:r}=Rt(y),v=!f.RMP_CLOUD&&b+1>ee,_=!f.RMP_CLOUD&&w+1>ne,T=!f.RMP_CLOUD||c==="none";se();const[j,H]=$.useState({x:0,y:0}),[N,ot]=$.useState({x:0,y:0}),[at,ht]=$.useState({x:0,y:0}),[ct,vt]=$.useState({x:0,y:0}),St=B(async a=>{const{x:A,y:E}=et(a);if(n.startsWith("station")||n.startsWith("misc-node")){t(st("free"));const M=nt(10),{x:z,y:D}=J(A,E,l,d),L=n.startsWith("station"),W=L?"stn_".concat(M):"misc_node_".concat(M),K=L?n.slice(8):n.slice(10),U=structuredClone({...dt,...ut}[K].defaultAttrs);if(re.has(K)&&(U.color=m),L&&!T){const Q=U.names,ft=await t(Wt(_t.Shmetro));if(Wt.fulfilled.match(ft)){const X=ft.payload;Q.length>X.length?X.push(...Array(Q.length-X.length).fill(X.at(-1))):Q.length<X.length&&X.splice(Q.length,X.length-Q.length),U.names=X}}e.current.addNode(W,{visible:!0,zIndex:0,x:O(z,5),y:O(D,5),type:K,[K]:U}),h(),o&&gt.event(pt.ADD_STATION,{type:K}),t(rt(new Set([W])))}else n==="free"||n.startsWith("line")?(n.startsWith("line")&&(t(st("free")),p&&t(ae(!1))),ht({x:A,y:E}),vt(d),a.shiftKey||(t(Et("background")),t(xt()))):n==="select"&&(H(J(A,E,l,d)),ot(J(A,E,l,d)))}),bt=B(a=>{if(n==="select"){if(j.x!=0&&j.y!=0){const{x:A,y:E}=et(a);ot(J(A,E,l,d))}}else if(g==="background"){const{x:A,y:E}=et(a);t(yt({x:ct.x+(at.x-A)*l/100,y:ct.y+(at.y-E)*l/100}))}}),At=B(a=>{if(n==="select"){const{x:A,y:E}=et(a),{x:M,y:z}=J(A,E,l,d),D=Xt(e.current,j.x,j.y,M,z),L=de(e.current,new Set(D));t(rt(new Set([...a.shiftKey?s:[],...D,...L]))),t(st("free")),H({x:0,y:0}),ot({x:0,y:0})}g==="background"&&!a.shiftKey&&t(Et(void 0))}),wt=B(a=>{let A=l;a.deltaY>0&&l+10<400?A=l+10:a.deltaY<0&&l-10>0&&(A=l-10),t(Dt(A));const{x:E,y:M}=et(a),z=a.currentTarget.getBoundingClientRect(),[D,L]=[E/z.width,M/z.height];t(yt({x:d.x+E*l/100-r*A/100*D,y:d.y+M*l/100-u*A/100*L}))}),Pt=B(async a=>{if(tt?a.key==="Backspace":a.key==="Delete")s.size>0&&(s.forEach(A=>{e.current.hasNode(A)?e.current.dropNode(A):e.current.hasEdge(A)&&e.current.dropEdge(A)}),t(xt()),h());else if(a.key.startsWith("Arrow")){const E=a.key.endsWith("Left")?-1:a.key.endsWith("Right")?1:0,M=a.key.endsWith("Up")?-1:a.key.endsWith("Down")?1:0;t(yt(J(100*E,100*M,l,d)))}else if(a.key==="z"&&(tt?a.metaKey&&!a.shiftKey:a.ctrlKey))tt&&a.preventDefault(),t(oe()),t(mt()),t(lt());else if(a.key==="s")t(st("select"));else if((a.key==="c"||a.key==="x")&&(tt?a.metaKey&&!a.shiftKey:a.ctrlKey)){const A=ue(e.current,s);navigator.clipboard.writeText(A),a.key==="x"&&(t(xt()),s.forEach(E=>{e.current.hasNode(E)?e.current.dropNode(E):e.current.hasEdge(E)&&e.current.dropEdge(E)}),h())}else if(a.key==="v"&&(tt?a.metaKey&&!a.shiftKey:a.ctrlKey)){const A=await navigator.clipboard.readText(),{x:E,y:M}=J(r/2,u/2,l,d),{nodes:z,edges:D}=he(A,e.current,v,_,O(E,5),O(M,5));h();const L=structuredClone(z);D.forEach(W=>L.add(W)),t(rt(L))}else(tt&&a.key==="z"&&a.metaKey&&a.shiftKey||!tt&&a.key==="y"&&a.ctrlKey)&&(t(ie()),t(mt()),t(lt()))}),[k,C]=$.useState(0),F=B(a=>{if(a.touches.length===2){t(Et(void 0));const[A,E]=[a.touches[0].clientX-a.touches[1].clientX,a.touches[0].clientY-a.touches[1].clientY];C(A*A+E*E)}}),it=B(a=>{if(k!==0&&a.touches.length===2){const[A,E]=[a.touches[0].clientX-a.touches[1].clientX,a.touches[0].clientY-a.touches[1].clientY],M=A*A+E*E;let z=l;M-k<0&&l+10<=390?z=l+10:M-k>0&&l-10>=10&&(z=l-10),t(Dt(z)),C(M);const D=a.currentTarget.getBoundingClientRect(),[L,W]=[(a.touches[0].clientX+a.touches[1].clientX)/2-D.left,(a.touches[0].clientY+a.touches[1].clientY)/2-D.top],[K,U]=[L/D.width,W/D.height];t(yt({x:d.x+L*l/100-r*z/100*K,y:d.y+W*l/100-u*z/100*U}))}}),Z=B(a=>{k!==0&&C(0)}),[Y,R]=$.useState({sx:0,sy:0,ex:0,ey:0});return $.useEffect(()=>{R({sx:j.x<=N.x?j.x:N.x,ex:j.x>N.x?j.x:N.x,sy:j.y<=N.y?j.y:N.y,ey:j.y>N.y?j.y:N.y})},[N.x,N.y]),S.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,userSelect:"none",touchAction:"none"},height:u,width:r,viewBox:"".concat(d.x," ").concat(d.y," ").concat(r*l/100," ").concat(u*l/100),onPointerDown:St,onPointerMove:bt,onPointerUp:At,onTouchStart:F,onTouchMove:it,onTouchEnd:Z,onWheel:wt,tabIndex:0,onKeyDown:Pt,children:[x&&S.jsx(ge,{svgViewBoxMin:d,svgViewBoxZoom:l,svgWidth:r,svgHeight:u}),S.jsx(le.SvgAssetsContextProvider,{children:S.jsx(ke,{})}),n==="select"&&j.x!=0&&j.y!=0&&S.jsx("rect",{x:Y.sx,y:Y.sy,width:Y.ex-Y.sx,height:Y.ey-Y.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),S.jsx("defs",{children:S.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[S.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),S.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})};export{$e as default};
