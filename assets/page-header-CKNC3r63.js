import{j as e,af as re,M as ee,ag as ie,G as te,H as ae,J as se,h as Ct,ah as Ts,K as f,B as _,ai as Be,aj as Ye,T as he,ak as pe,b as ue,q as mt,N,L as ce,al as _s,am as ks,an as Pe,Q as L,ao as U,O as is,ap as Pt,aq as Dt,a1 as le,ar as Bt,as as xe,v as me,at as xt,R as vt,U as At,V as Ft,X as Zt,au as Ot,A as Ms,E as zs,n as as,a7 as ls,e as cs,t as ds,m as hs,z as ps,av as Es,aw as Rs,ax as Ns,ay as Is,az as Ls,aA as Ee,aB as Ps,a6 as De,a0 as Ds,aC as Bs,aD as Ws,aE as q,aF as Yt,aG as Gs,aH as I,aI as M,aJ as $s}from"./chakra-C_7_uw7b.js";import{u as Us,r as E,C as us,M as ht,d as Ce,n as Tt,S as D,R as _t,a as gs,b as W,c as F,e as G,f as Hs,g as Vs,h as Fs,i as Zs,j as Fe,k as Ne,E as Ie,s as Ys,l as lt,m as Ks,L as Xe,o as ms,p as ct,q as Wt,t as Gt,v as $t,w as Q,x as K,y as oe,z as xs,A as Js,B as fs,D as kt,F as Ge,G as qe,H as Kt,I as Jt,J as Xs,K as qs,N as Qs,O as Xt,P as en,Q as qt,T as tn,U as sn,V as nn,W as js,X as on,Y as rn,Z as dt,_ as bs,$ as ys,a0 as an,a1 as ln,a2 as cn,a3 as dn,a4 as hn,a5 as pn,a6 as un,a7 as gn,a8 as rt,a9 as mn,aa as xn,ab as Me,ac as fn,ad as jn,ae as bn,af as yn,ag as Se,ah as wn,ai as Sn,aj as Qt,ak as Cn,al as vn,am as ft,an as An,ao as On,ap as Tn,aq as _n,ar as kn,as as Mn,at as zn,au as En,av as Rn,aw as Nn,ax as In}from"./index-B4jp-iTk.js";import{u as H,d as x,T as Mt,a as it}from"./react-YtWR-Zuw.js";import{d as zt,m as Ln,a as Pn,s as Qe,f as Dn,M as Bn}from"./master-manager-BmEPk8qa.js";var es=function(t){return Us(E.ready(),t)};const Wn=t=>{const{isOpen:r,onClose:a}=t,{t:s}=H(),o=E.getAppVersion();return e.jsxs(re,{isOpen:r,onClose:a,size:"xl",scrollBehavior:"inside",children:[e.jsx(ee,{}),e.jsxs(ie,{children:[e.jsx(te,{children:s("header.about.title")}),e.jsx(ae,{}),e.jsxs(se,{paddingBottom:10,children:[e.jsxs(Ct,{direction:"row",children:[e.jsx(Ts,{boxSize:"128px",src:"/rmp//logo192.png"}),e.jsxs(Ct,{direction:"column",width:"100%",alignItems:"center",justifyContent:"center",children:[e.jsx(f,{fontSize:"xl",as:"b",children:s("header.about.rmp")}),e.jsx(f,{children:o}),e.jsx(f,{}),e.jsx(f,{fontSize:"sm",children:s("header.about.railmapgen")})]})]}),e.jsx(_,{margin:5,children:e.jsx(f,{fontSize:"xl",children:s("header.about.desc")})}),e.jsx(Be,{as:"h5",size:"sm",mt:3,mb:2,children:s("header.about.contributors")}),e.jsx(Be,{as:"h6",size:"xs",my:2,children:s("header.about.coreContributors")}),e.jsxs(Ye,{children:[e.jsxs(he,{size:"lg",w:"85%",onClick:()=>window.open("https://github.com/thekingofcity","_blank"),cursor:"pointer",children:[e.jsx(pe,{src:"https://github.com/thekingofcity.png",size:"lg",my:2,ml:-1,mr:2}),e.jsxs(ue,{display:"block",width:"100%",children:[e.jsx(f,{fontSize:"lg",fontWeight:"bold",mb:1,children:"thekingofcity"}),e.jsx(f,{fontSize:"sm",children:s("header.about.content1")}),e.jsx(f,{fontSize:"sm",align:"right",mb:1,children:s("header.about.content2")})]})]}),e.jsxs(he,{size:"lg",w:"85%",onClick:()=>window.open("https://github.com/langonginc","_blank"),cursor:"pointer",children:[e.jsx(pe,{src:"https://github.com/langonginc.png",size:"lg",my:2,ml:-1,mr:2}),e.jsxs(ue,{display:"block",width:"100%",children:[e.jsx(f,{fontSize:"lg",fontWeight:"bold",mb:1,children:"langonginc"}),e.jsx(f,{fontSize:"sm",children:s("header.about.langonginc")}),e.jsx(f,{fontSize:"sm",align:"right",mb:1,children:"--Avicii"})]})]})]}),e.jsx(Be,{as:"h6",size:"xs",my:2,children:s("header.about.styleContributors")}),e.jsxs(Ye,{children:[e.jsxs(he,{size:"lg",w:"85%",onClick:()=>window.open("https://github.com/203IhzElttil","_blank"),cursor:"pointer",children:[e.jsx(pe,{src:"https://github.com/203IhzElttil.png",size:"lg",my:2,ml:-1,mr:2}),e.jsxs(ue,{display:"block",width:"100%",children:[e.jsx(f,{fontSize:"lg",fontWeight:"bold",mb:1,children:"203IhzElttil"}),e.jsx(f,{fontSize:"sm",mb:1,children:s("header.about.203IhzElttil")})]})]}),e.jsxs(he,{size:"lg",w:"85%",onClick:()=>window.open("https://github.com/Swiftiecott","_blank"),cursor:"pointer",children:[e.jsx(pe,{src:"https://github.com/Swiftiecott.png",size:"lg",my:2,ml:-1,mr:2}),e.jsxs(ue,{display:"block",width:"100%",children:[e.jsx(f,{fontSize:"lg",fontWeight:"bold",mb:1,children:"Swiftiecott"}),e.jsx(f,{fontSize:"sm",mb:1,children:s("header.about.Swiftiecott")})]})]}),e.jsxs(he,{size:"lg",w:"85%",onClick:()=>window.open("https://github.com/Minwtraft","_blank"),cursor:"pointer",children:[e.jsx(pe,{src:"https://github.com/Minwtraft.png",size:"lg",my:2,ml:-1,mr:2}),e.jsxs(ue,{display:"block",width:"100%",children:[e.jsx(f,{fontSize:"lg",fontWeight:"bold",mb:1,children:"Minwtraft"}),e.jsx(f,{fontSize:"sm",mb:1,children:s("header.about.Minwtraft")})]})]})]}),e.jsx(Be,{as:"h5",size:"sm",mt:3,mb:2,children:s("header.about.contactUs")}),e.jsxs(Ye,{children:[e.jsxs(he,{size:"lg",w:"85%",onClick:()=>window.open("https://github.com/railmapgen/rmp/issues","_blank"),cursor:"pointer",children:[e.jsx(pe,{src:"images/github-mark.svg",size:"lg",my:2,ml:-1,mr:2}),e.jsxs(ue,{display:"block",width:"100%",children:[e.jsx(f,{fontSize:"lg",fontWeight:"bold",mb:1,children:s("header.about.github")}),e.jsx(f,{fontSize:"sm",children:s("header.about.githubContent")})]})]}),e.jsxs(he,{size:"lg",w:"85%",onClick:()=>window.open("https://join.slack.com/t/railmapgenerator/shared_invite/zt-1odhhta3n-DdZF~fnVwo_q0S0RJmgV8A","_blank"),cursor:"pointer",children:[e.jsx(pe,{src:"images/slack-mark.svg",size:"lg",my:2,ml:-1,mr:2}),e.jsxs(ue,{display:"block",width:"100%",children:[e.jsx(f,{fontSize:"lg",fontWeight:"bold",mb:1,children:s("header.about.slack")}),e.jsx(f,{fontSize:"sm",children:s("header.about.slackContent")}),e.jsx(f,{fontSize:"sm",as:"i",children:"#rmp, #gallery, #rmg, #palette-and-templates"})]})]})]}),e.jsx(Be,{as:"h5",size:"sm",mt:3,mb:2,children:s("header.donation.title")}),e.jsxs(Ye,{children:[e.jsxs(he,{size:"lg",w:"85%",onClick:()=>window.open("https://afdian.com/a/rail-map-toolkit","_blank"),cursor:"pointer",children:[e.jsx(pe,{src:"images/afdian.png",size:"lg",my:2,ml:-1,mr:2}),e.jsxs(ue,{display:"block",width:"100%",pb:1,children:[e.jsx(f,{fontSize:"lg",fontWeight:"bold",mb:1,children:s("header.donation.afdian")}),e.jsx(f,{fontSize:"sm",children:s("header.donation.viaCNY")})]})]}),e.jsxs(he,{size:"lg",w:"85%",onClick:()=>window.open("https://opencollective.com/rail-map-toolkit","_blank"),cursor:"pointer",children:[e.jsx(pe,{src:"images/opencollective-icon.webp",size:"lg",my:2,ml:-1,mr:2}),e.jsxs(ue,{display:"block",width:"100%",pb:1,children:[e.jsx(f,{fontSize:"lg",fontWeight:"bold",mb:1,children:s("header.donation.openCollective")}),e.jsx(f,{fontSize:"sm",children:s("header.donation.viaUSD")})]})]})]})]})]})]})};/*!
 * canvas-size
 * v2.0.0
 * https://github.com/jhildenbiddle/canvas-size
 * (c) 2015-2024 John Hildenbiddle <http://hildenbiddle.com>
 * MIT license
 */function et(t){const r=t.sizes.shift(),a=Math.max(Math.ceil(r[0]),1),s=Math.max(Math.ceil(r[1]),1),o=[a-1,s-1,1,1],n=performance.now(),i=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope;let c,d;i?(c=new OffscreenCanvas(1,1),d=new OffscreenCanvas(a,s)):(c=document.createElement("canvas"),c.width=1,c.height=1,d=document.createElement("canvas"),d.width=a,d.height=s);const u=c.getContext("2d"),b=d.getContext("2d");b&&(b.fillRect.apply(b,o),u.drawImage(d,a-1,s-1,1,1,0,0,1,1));const h=u&&u.getImageData(0,0,1,1).data[3]!==0,l=parseInt(performance.now()-n);return[c,d].forEach(g=>{g.height=0,g.width=0}),i?(postMessage({width:a,height:s,testTime:l,isTestPass:h}),!h&&t.sizes.length&&setTimeout(()=>{et(t)},0)):h?t.onSuccess({width:a,height:s,testTime:l}):(t.onError({width:a,height:s,testTime:l}),t.sizes.length&&setTimeout(()=>{et(t)},0)),h}const jt={area:[16384,14188,11402,11180,10836,8192,4096,1],height:[8388607,65535,32767,16384,8192,4096,1],width:[4194303,65535,32767,16384,8192,4096,1]},We={max:null,min:1,sizes:[],step:1024,useWorker:!1,onError:Function.prototype,onSuccess:Function.prototype},Ze={};function bt(t){const r=t.width===t.height,a=t.height===1,s=t.width===1,o=[];if(!t.width||!t.height)t.sizes.forEach(n=>{const i=r||a?n:1,c=r||s?n:1;o.push([i,c])});else{const n=t.min||We.min,i=t.step||We.step;let c=Math.max(t.width,t.height);for(;c>=n;){const d=r||a?c:1,u=r||s?c:1;o.push([d,u]),c-=i}}return o}function at(t){const r=typeof window<"u",a=r&&"Promise"in window,s=r&&"HTMLCanvasElement"in window,o=r&&"OffscreenCanvas"in window,n=URL.createObjectURL(new Blob([])).slice(-36),i=performance.now(),{onError:c,onSuccess:d,...u}=t,b=()=>parseInt(performance.now()-i);let h=null;if(!s)return!1;if(t.useWorker&&o){const l="\n            var canvasTest = ".concat(et.toString(),";\n            onmessage = function(e) {\n                canvasTest(e.data);\n            };\n        "),g=new Blob([l],{type:"application/javascript"}),p=URL.createObjectURL(g);h=new Worker(p),URL.revokeObjectURL(p),h.onmessage=function(m){const{width:j,height:S,testTime:w,isTestPass:C}=m.data,A={width:j,height:S,testTime:w,totalTime:b()};C?(Ze[n].onSuccess(A),delete Ze[n]):Ze[n].onError(A)}}if(a)return new Promise(l=>{const g={...t,onError(p){let{width:m,height:j,testTime:S}=p;const w={width:m,height:j,testTime:S,totalTime:b()};let C;if(t.sizes.length===0)C=!0;else{const[[A,v]]=t.sizes.slice(-1);C=m===A&&j===v}c(w),C&&l({...w,success:!1})},onSuccess(p){let{width:m,height:j,testTime:S}=p;const w={width:m,height:j,testTime:S,totalTime:b()};d(w),l({...w,success:!0})}};if(h){const{onError:p,onSuccess:m}=g;Ze[n]={onError:p,onSuccess:m},h.postMessage(u)}else et(g)});if(h)Ze[n]={onError:c,onSuccess:d},h.postMessage(u);else return et(t)}const Gn={maxArea(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const r=bt({width:t.max,height:t.max,min:t.min,step:t.step,sizes:[...jt.area]}),a={...We,...t,sizes:r};return at(a)},maxHeight(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const r=bt({width:1,height:t.max,min:t.min,step:t.step,sizes:[...jt.height]}),a={...We,...t,sizes:r};return at(a)},maxWidth(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const r=bt({width:t.max,height:1,min:t.min,step:t.step,sizes:[...jt.width]}),a={...We,...t,sizes:r};return at(a)},test(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const r={...We,...t};return r.sizes=[...r.sizes],r.width&&r.height&&(r.sizes=[[r.width,r.height]]),at(r)}};var tt=(t=>(t.left="l",t.right="r",t))(tt||{}),Re=(t=>(t.through="through",t.nonThrough="nonthrough",t))(Re||{}),pt=(t=>(t.local="local",t.express="express",t.direct="direct",t))(pt||{}),ve=(t=>(t.MTR="mtr",t.GZMTR="gzmtr",t.SHMetro="shmetro",t))(ve||{}),Ut=(t=>(t.sh="sh",t.sh2020="sh2020",t))(Ut||{});const fe=new Set,Et=new Set,Rt=new Set,Nt=new Set,ws=new Map,Ae=new Map,yt=new Set,wt=new Map,ne=new Map;let $=[],Ke=0;const Je=new Map,St=new Map,It=new Set,$n={localisedName:{en:"LEFT END"},num:"00",services:[pt.local],parents:[],children:["lineend"],transfer:{groups:[{}],tick_direc:tt.right,paid_area:!0},loop_pivot:!1,one_line:!0,int_padding:355,character_spacing:0},Un={localisedName:{en:"RIGHT END"},num:"00",services:[pt.local],parents:[],children:[],transfer:{groups:[{}],tick_direc:tt.right,paid_area:!0},loop_pivot:!1,one_line:!0,int_padding:355,character_spacing:0},Hn={},Ss={svgWidth:{destination:1500,runin:1500,railmap:1500,indoor:1500},svg_height:400,style:ve.SHMetro,y_pc:50,padding:10,branchSpacingPct:33,direction:tt.right,platform_num:"1",theme:[us.Shanghai,"sh1","#E3002B",ht.white],line_name:["地鐵線","Metro Line"],current_stn_idx:"jlaMj2",stn_list:Hn,namePosMTR:{isStagger:!0,isFlip:!0},customiseMTRDest:{isLegacy:!1,terminal:!1},line_num:"1",psd_num:"1",info_panel_type:Ut.sh,direction_gz_x:40,direction_gz_y:70,coline:{},loop:!1,loop_info:{bank:!0,left_and_right_factor:0,bottom_factor:1},coachNum:"1"},Vn={localisedName:{},num:"",services:[pt.local],parents:[],children:[],transfer:{groups:[{}],tick_direc:tt.right,paid_area:!0},loop_pivot:!1,one_line:!0,int_padding:355,character_spacing:0},z=t=>"".concat(t[0],"/").concat(t[1],"=").concat(t[2]).concat(t[3]),Ht=t=>Ce.has(t),Fn=t=>{if(Ht(t.style))return structuredClone(t[t.style].color)},Zn=(t,r)=>{const[a,s]=t.extremities(r),o=t.getEdgeAttributes(r),n=o.style;if(a!=s&&Ht(n)){const i=Fn(o);Nt.has(z(i))||(Rt.add(i),Nt.add(z(i)),ws.set(i,a),Ae.set(z(i),new Set)),Ae.get(z(i)).add(a),Ae.get(z(i)).add(s),ne.has(a)?$.push({target:s,next:ne.get(a),color:i}):$.push({target:s,next:-1,color:i}),ne.set(a,Ke),Ke++,ne.has(s)?$.push({target:a,next:ne.get(s),color:i}):$.push({target:a,next:-1,color:i}),ne.set(s,Ke),Ke++}},Cs=(t,r,a)=>{if(Ae.get(z(a)).has(t)){Ae.get(z(a)).delete(t);for(let s=ne.get(t);s!=-1;s=$[s].next){const o=$[s].target,n=$[s].color;z(n)==z(a)&&Cs(o,t,a)}}},vs=(t,r,a)=>{if(fe.has(t))return;fe.add(t);let s=0;const o=new Set;for(let n=ne.get(t);n!=-1;n=$[n].next){const i=$[n].target,c=$[n].color;z(c)==z(a)&&(o.has(i)||(o.add(i),s++,i!=r&&vs(i,t,a)))}Je.set(t,s)},ts=(t,r)=>{const a=t.stn_list.lineend.parents;a.push(r),t.stn_list.lineend.parents=structuredClone(a).reverse(),t.stn_list.lineend.branch={...t.stn_list.lineend.branch,left:t.stn_list.lineend.parents.length==2?[Re.through,a[1]]:void 0}},Yn=(t,r)=>{let a=0;for(let s=ne.get(t);s!=-1;s=$[s].next){$[s].target;const o=$[s].color;z(o)==z(r)&&a++}return a},As=(t,r,a)=>{if(It.has(t))return[];It.add(t);const s=[];for(let o=ne.get(t);o!=-1;o=$[o].next){const n=$[o].target,i=$[o].color;n!=r&&z(i)==z(a)&&(n.startsWith("stn")?s.push(n):s.push(...As(n,t,a)))}return s},Lt=(t,r,a,s,o,n,i)=>{var l;if(fe.has(t)&&(!t.startsWith("misc_node_")&&i.stn_list[t]==null||t.startsWith("misc_node_")&&!Et.has(t)||i.loop))return[];if(fe.has(t)&&i.stn_list[t]!=null&&Yn(t,n)-1>=2){const g=[...i.stn_list[t].parents,r];if(i.stn_list[g[1]]==null){const j=g[0];g[0]=g[1],g[1]=j}i.stn_list[t].parents=structuredClone(g).reverse(),i.stn_list[t].branch={...i.stn_list[t].branch,left:[Re.through,g[1]]};const p=[];for(const j of i.stn_list[t].children)j!=r&&p.push(j);i.stn_list[t].children=structuredClone(p),(l=i.stn_list[t].branch)==null||delete l.right;const m=[];for(const j of i.stn_list.lineend.parents)j!=t&&m.push(j);return i.stn_list.lineend.parents=structuredClone(m).reverse(),i.stn_list.lineend.branch={...i.stn_list.lineend.branch,left:i.stn_list.lineend.parents.length==2?[Re.through,m[1]]:void 0},p.length==0&&(i.stn_list[t].children=["lineend"],ts(i,t)),[t]}fe.add(t);const c=[],d=[],u=[],b=new Set,h=new Set;for(let g=ne.get(t);g!=-1;g=$[g].next){const p=$[g].target,m=$[g].color;if(p!=a){if(z(m)==z(n)){if(h.has(p))continue;if(h.add(p),t.startsWith("misc_node_")){const j=Lt(p,r,t,s+1,o,n,i);j.length!=0&&c.push(...j)}else{const j=Lt(p,t,t,s+1,o,n,i);j.length!=0&&c.push(...j)}}if(!b.has(z(m))&&z(m)!=z(n)){b.add(z(m));const j={theme:m,name:["ch_".concat(z(m)),"en_".concat(z(m))]};u.push(j)}}}if(c.length==2){for(let g=0;g<2;g++)c[g]=="lineend"&&c.splice(g,1);if(i.stn_list[c[1]].parents.length>=2){const g=c[0];c[0]=c[1],c[1]=g}}if(fe.has(t)&&i.stn_list[t]!=null){const g=[];for(const p of i.stn_list.lineend.parents)p!=t&&g.push(p);i.stn_list.lineend.parents=structuredClone(g).reverse(),i.stn_list.lineend.branch={...i.stn_list.lineend.branch,left:i.stn_list.lineend.parents.length==2?[Re.through,g[1]]:void 0},c.length==0&&(It.clear(),d.push(...As(t,r,n)))}if(t.startsWith("misc_node_"))return Et.add(t),c;{const g=o.getNodeAttributes(t).type,p=o.getNodeAttributes(t)[g];if(i.stn_list[t]=structuredClone(Vn),i.stn_list[t].localisedName={zh:p.names[0],en:p.names[1]},i.stn_list[t].num=String(s),o.getNodeAttributes(t).type==D.GzmtrBasic){const m=p;i.stn_list[t].num=m.stationCode,(m.secondaryNames[0]!==""||m.secondaryNames[1]!=="")&&(i.stn_list[t].localisedSecondaryName={zh:m.secondaryNames[0],en:m.secondaryNames[1]})}if(o.getNodeAttributes(t).type==D.GzmtrInt){const m=p,j=m.transfer[0];for(const S of j)if(z(S)==z(n)){i.stn_list[t].num=String(S[5]);break}(m.secondaryNames[0]!==""||m.secondaryNames[1]!=="")&&(i.stn_list[t].localisedSecondaryName={zh:m.secondaryNames[0],en:m.secondaryNames[1]})}return c.length!=0?(i.stn_list[t].children=structuredClone(c).reverse(),c.length==2&&(i.stn_list[t].branch={...i.stn_list[t].branch,right:[Re.through,c[1]]})):(i.stn_list[t].children=["lineend"],ts(i,t)),d.push(r),i.stn_list[t].parents=structuredClone(d).reverse(),d.length==2&&(i.stn_list[t].branch={...i.stn_list[t].branch,left:[Re.through,d[1]]}),u.length!=0&&(i.stn_list[t].transfer.groups[0].lines=structuredClone(u)),[t]}},Kn=(t,r,a,s)=>{const o=structuredClone(Ss);s=="LOOP"&&(o.loop=!0);let n;switch(t.getNodeAttributes(a).type){case D.GzmtrBasic:case D.GzmtrInt:n=ve.GZMTR;break;case D.MTR:n=ve.MTR;break;default:n=ve.SHMetro;break}o.theme=structuredClone(r),o.style=n,o.stn_list.linestart=structuredClone($n),o.stn_list.lineend=structuredClone(Un),fe.clear(),Et.clear();const i=Lt(a,"linestart","linestart",1,t,r,o);if(o.current_stn_idx=i[0],o.stn_list.linestart.children=[i[0]],!(Object.keys(o.stn_list).length<=3||o.stn_list.lineend.parents.length>=3))return structuredClone(o)},Jn=t=>{var s,o;fe.clear(),Rt.clear(),Nt.clear(),ws.clear(),Ae.clear(),yt.clear(),wt.clear(),ne.clear(),$=[],Ke=0,Je.clear(),St.clear(),t.filterEdges(n=>n.startsWith("line")).forEach(n=>{Ht(t.getEdgeAttributes(n).style)&&Zn(t,n)});let r=0;t.forEachNode(n=>{St.set(n,++r)}),St.set("lineend",++r);const a=[];for(const n of Rt){let i=0;for(;Ae.get(z(n)).size!=0;){let c="line_root";Ae.get(z(n)).forEach(u=>{c=="line_root"&&(c=u)}),Cs(c,"line_root",n);const d={theme:n,index:++i};yt.add(d),wt.set(d,c)}}for(const n of yt){const{theme:i}=n;fe.clear(),Je.clear(),vs(wt.get(n),"line_root",i);let c=!0,d="LINE";const u=[];for(const[h,l]of Je)l==1&&u.push(h),l==3&&(d="BRANCH"),l>3&&(c=!1);if(!c)continue;u.length==0&&(d="LOOP",Je.forEach((h,l)=>{u.push(l)}));const b=[];for(const h of u){const l=Kn(t,i,h,d);l!=null&&b.push([l,(s=l.stn_list[l.current_stn_idx].localisedName.zh)!=null?s:"",(o=l.stn_list[l.current_stn_idx].localisedName.en)!=null?o:""])}b.length!=0&&a.push({id:Tt(10),theme:i,param:structuredClone(b),type:d})}return a},Xn=t=>t[0]!=""&&t[1]!=""?t[0]+"_"+t[1]:t[0]!=""?t[0]:t[1]!=""?t[1]:"".concat(new Date().valueOf()),qn=(t,r)=>{let a=t;return r.forEach((s,o)=>{const n=new RegExp("ch_".concat(o),"g"),i=new RegExp("en_".concat(o),"g");a=a.replace(n,s[0]),a=a.replace(i,s[1])}),a},Qn=(t,r,a,s)=>{t.line_name=r,t.line_num=String(a),zt("RMG_".concat(Xn(r),".json"),"application/json",qn(JSON.stringify(t),s))},eo={LINE:"#33ccff",BRANCH:"#007B61",LOOP:"#ff6666"},to=t=>{const{isOpen:r,onClose:a}=t,{t:s}=H(),o=x.useRef(window.graph),[n,i]=x.useState(!1),[c,d]=x.useState([[Ss,"",""]]),[u,b]=x.useState(["","",""]),[h,l]=x.useState(new Map),[g,p]=x.useState(new Map),[m,j]=x.useState([]);x.useEffect(()=>{if(r){const w=Jn(o.current),C=new Map;w.forEach(({id:A,theme:v})=>{C.set(z(v),A)}),j(w),l(C)}},[r]);const S=(w,C)=>document.getElementById("2RMG_"+C+"_"+w).value.trim();return e.jsxs(re,{isOpen:r,onClose:a,size:"2xl",scrollBehavior:"inside",blockScrollOnMount:!1,children:[e.jsx(ee,{}),e.jsxs(ie,{children:[e.jsx(te,{children:e.jsx(f,{as:"b",fontSize:"xl",children:s("header.download.2rmg.title")})}),e.jsx(ae,{}),e.jsxs(se,{children:[e.jsx(f,{fontSize:"sm",mt:"3",lineHeight:"100%",children:s("header.download.2rmg.info1")}),e.jsx(f,{fontSize:"sm",mt:"3",lineHeight:"100%",children:s("header.download.2rmg.info2")}),e.jsx("br",{}),m.length===0?e.jsx(f,{fontSize:"md",children:s("header.download.2rmg.noline")}):e.jsx("table",{children:e.jsx("tbody",{children:m.map(({id:w,theme:C,param:A,type:v})=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx(_t,{name:C[0]=="other"&&C[1]=="other"?C[2]:C[1],bg:C[2],fg:C[3]})}),e.jsx("td",{children:e.jsx(mt,{placeholder:s("header.download.2rmg.placeholder.chinese"),id:"2RMG_nameCh_".concat(w),size:"sm"})}),e.jsx("td",{children:e.jsx(mt,{placeholder:s("header.download.2rmg.placeholder.english"),id:"2RMG_nameEn_".concat(w),size:"sm"})}),e.jsx("td",{children:e.jsx(mt,{placeholder:s("header.download.2rmg.placeholder.lineCode"),id:"2RMG_lineNum_".concat(w),size:"sm"})}),e.jsx("td",{children:e.jsx(_t,{name:s("header.download.2rmg.type.".concat(v.toLowerCase())),bg:eo[v],fg:ht.white})}),e.jsx("td",{children:e.jsx(N,{colorScheme:"blue",variant:"ghost",mr:"1",onClick:()=>{const O=S(w,"nameCh"),k=S(w,"nameEn"),P=S(w,"lineNum"),V=new Map;h.forEach((Z,Y)=>{V.set(Y,[S(Z,"nameCh"),S(Z,"nameEn")])}),d(A),b([O,k,P]),p(V),i(!0)},size:"sm",children:e.jsx(gs,{})})})]},w))})})]}),e.jsx(ce,{children:e.jsx(N,{colorScheme:"blue",variant:"outline",mr:"1",onClick:a,children:s("close")})})]}),e.jsx(so,{isOpen:n,onClose:()=>i(!1),param:c,nameList:u,interchangeName:g})]})},so=t=>{const{isOpen:r,onClose:a,param:s,nameList:o,interchangeName:n}=t,{t:i}=H(),[c,d]=x.useState("");return x.useEffect(()=>{o[0]!=""&&o[1]!=""?d(o[0]+"/"+o[1]):o[0]!=""?d(o[0]):o[1]!=""?d(o[1]):d("")},[...o]),e.jsxs(re,{isOpen:r,onClose:a,size:"md",scrollBehavior:"inside",children:[e.jsx(ee,{}),e.jsxs(ie,{children:[e.jsx(te,{children:e.jsxs(f,{as:"b",fontSize:"xl",children:[i("header.download.2rmg.download")," ",c]})}),e.jsx(ae,{}),e.jsx(se,{children:e.jsxs(_s,{children:[e.jsx(f,{fontSize:"sm",mb:"2",lineHeight:"100%",children:i("header.download.2rmg.downloadInfo")}),s.map(([u,b,h])=>e.jsxs(N,{onClick:()=>{Qn(u,[o[0],o[1]],o[2],n)},overflow:"hidden",size:"md",textOverflow:"ellipsis",whiteSpace:"nowrap",display:"ruby",children:[b.replaceAll("\n","⏎"),"/",h.replaceAll("\n","⏎")]},"".concat(b).concat(h)))]})}),e.jsx(ce,{children:e.jsx(N,{colorScheme:"blue",variant:"outline",mr:"1",onClick:a,children:i("close")})})]})]})},no=t=>{const{isOpen:r,onClose:a}=t,{t:s}=H();return e.jsxs(re,{isOpen:r,onClose:a,size:"xl",scrollBehavior:"inside",children:[e.jsx(ee,{}),e.jsxs(ie,{children:[e.jsx(te,{children:s("header.download.termsAndConditions")}),e.jsx(ae,{}),e.jsx(se,{children:e.jsxs(ks,{children:[e.jsxs(Pe,{children:["The layout of the elements on the signage or rail map, is designed by"," ",e.jsxs(L,{color:"teal.500",href:"https://www.shmetro.com/",isExternal:!0,children:["Shanghai Shentong Metro Group ",e.jsx(U,{as:W})]}),", ",e.jsxs(L,{color:"teal.500",href:"https://www.gzmtr.com/",isExternal:!0,children:["Guangzhou Metro Group ",e.jsx(U,{as:W})]})," or ",e.jsxs(L,{color:"teal.500",href:"https://www.mtr.com.hk/",isExternal:!0,children:["MTR Corporation ",e.jsx(U,{as:W})]}),", depending on your selection. You shall grant appropriate permit or license from the relevant company above before using the generated images for commercial purposes, if it is required to do so.",e.jsx("br",{}),"标志版或路线图的元素或布局，基于你所选择的风格，为",e.jsxs(L,{color:"teal.500",href:"https://www.shmetro.com/",isExternal:!0,children:["上海申通地铁集团 ",e.jsx(U,{as:W})]}),"，",e.jsxs(L,{color:"teal.500",href:"https://www.gzmtr.com/",isExternal:!0,children:["广州地铁集团公司 ",e.jsx(U,{as:W})]}),"或",e.jsxs(L,{color:"teal.500",href:"https://www.mtr.com.hk/",isExternal:!0,children:["港铁公司 ",e.jsx(U,{as:W})]}),"所设计。在产生的图像用作商业用途前，你应向相关公司取得适当之许可证或授权。"]}),e.jsxs(Pe,{children:["The elements including shapes and lines on the image are drawn by"," ",e.jsxs(L,{color:"teal.500",href:"https://www.github.com/thekingofcity",isExternal:!0,children:["thekingofcity ",e.jsx(U,{as:W})]})," and ",e.jsxs(L,{color:"teal.500",href:"https://www.github.com/wongchito",isExternal:!0,children:["Chito Wong ",e.jsx(U,{as:W})]}),", based on the design standards or rules of the companies listed above. You may use them for any purposes, but it is recommended to state the name and the link of software alongside.",e.jsx("br",{}),"图像的元素，包括图形及线条，均由",e.jsxs(L,{color:"teal.500",href:"https://www.github.com/thekingofcity",isExternal:!0,children:["thekingofcity ",e.jsx(U,{as:W})]}),"及",e.jsxs(L,{color:"teal.500",href:"https://www.github.com/wongchito",isExternal:!0,children:["Chito Wong ",e.jsx(U,{as:W})]}),"基于上述公司设计标准或准则绘制。你可将其用于任何目的，但我们建议你于使用同时附以我们的名字以及本网站地址。"]}),e.jsxs(Pe,{children:["Due to copyright, licensing and other legal restrictions, Rail Map Painter uses"," ",e.jsxs(L,{color:"teal.500",href:"https://github.com/ButTaiwan/genyo-font",isExternal:!0,children:["GenYoMin provided by ButTaiwan ",e.jsx(U,{as:W})]}),", and Vegur instead of MTRSung and Myriad Pro respectively to display and generate MTR-style signage. You shall grant appropriate permit or license from the manufacturers before using those generated images for commercial purposes.",e.jsx("br",{}),"由于著作权及其他法律限制，铁路路线图绘制器使用由",e.jsxs(L,{color:"teal.500",href:"https://github.com/ButTaiwan/genyo-font",isExternal:!0,children:["ButTaiwan提供的源樣明體 ",e.jsx(U,{as:W})]}),"，以及Vegur，以代替港铁样式标志牌所使用的地铁宋及Myriad Pro。在产生之图像用作商业用途前，你应向字型生产厂商取得适当之许可证或授权。"]}),e.jsxs(Pe,{children:["The exported images in PNG or SVG format may be modified, published, or used for other purposes except commercial use, under the conditions above.",e.jsx("br",{}),"输出的PNG或SVG图像可基于上述条款，在非商业使用时，用于修改、发行或其他用途。"]}),e.jsxs(Pe,{children:["All flag emojis shown on Windows platforms are designed by"," ",e.jsxs(L,{color:"teal.500",href:"https://openmoji.org/",isExternal:!0,children:["OpenMoji ",e.jsx(U,{as:W})]})," ","– the open-source emoji and icon project. License:",e.jsxs(L,{color:"teal.500",href:"https://creativecommons.org/licenses/by-sa/4.0/",isExternal:!0,children:["CC BY-SA 4.0 ",e.jsx(U,{as:W})]}),e.jsx("br",{}),"于Windows作业系统上显示的国旗Emoji为",e.jsxs(L,{color:"teal.500",href:"https://openmoji.org/",isExternal:!0,children:["OpenMoji ",e.jsx(U,{as:W})]}),"所设计。许可证：",e.jsxs(L,{color:"teal.500",href:"https://creativecommons.org/licenses/by-sa/4.0/",isExternal:!0,children:["CC BY-SA 4.0 ",e.jsx(U,{as:W})]})]}),e.jsxs(Pe,{children:["We reserve the rights, without prior notice, to modify, add, or remove these terms. The Chinese translation is for reference only. In case of any discrepancy between the English version and the Chinese version, the English version shall prevail.",e.jsx("br",{}),"我们保留修改、新增或移除上述条款之权利，而无需另行通知。中文译本仅供参考，文义如与英文有歧异，概以英文本为准。"]})]})})]})]})},oo=()=>{const t="https://ghfast.top/https://github.com/railmapgen/railmapgen.github.io/releases/download",r=new Date,a="".concat(r.getFullYear()).concat(String(r.getMonth()+1).padStart(2,"0"),"01"),s="".concat(String(r.getFullYear()).slice(-2),".").concat(r.getMonth()+1,".1"),o=navigator.platform,n=o.includes("Linux")?"amd64.AppImage":o.includes("Mac")?"aarch64.dmg":"x64-setup.exe";return t+"/tauri-".concat(a,"/Rail.Map.Toolkit_").concat(s,"_").concat(n)};function ro(){const t=is("white","var(--chakra-colors-gray-800)"),r=F(),{activeSubscriptions:{RMP_EXPORT:a}}=G(T=>T.account),{telemetry:{project:s}}=G(T=>T.app),{languages:o}=G(T=>T.fonts),n=G(T=>T.param),i=E.isAllowAnalytics(),{t:c}=H(),d=x.useRef(window.graph),[u,b]=x.useState("png"),h={png:c("header.download.png"),svg:c("header.download.svg")},[l,g]=x.useState(2),[p,m]=x.useState({width:1,height:1,benchmark:.001}),[j,S]=x.useState(200),w=[25,50,100,150,200,250,300,400,500,750,1e3,1500,2e3],C=Object.fromEntries(w.map(T=>[T,"".concat(T,"%")])),[A,v]=x.useState([]),[O,k]=x.useState(!1),P=[{type:"select",label:c("header.download.format"),value:u,options:h,onChange:T=>b(T==="png"?"png":"svg")}],V=[{type:"select",label:c("header.download.svgVersion"),value:l,options:{1.1:c("header.download.svg1.1"),2:c("header.download.svg2")},onChange:T=>{g(T),T===1.1&&de(!0)}}],Z=[{type:"select",label:c("header.download.scale"),value:j,options:C,onChange:T=>S(T)},{type:"switch",label:c("header.download.transparent"),isChecked:O,onChange:k}],[Y,je]=x.useState(!1),[$e,be]=x.useState(!1),[Oe,de]=x.useState(!1),[Te,R]=x.useState(!1),[st,Ue]=x.useState(!1),[ut,ye]=x.useState(!1),[nt,we]=x.useState(!1);x.useEffect(()=>{(async()=>{const _e=await Gn.maxArea({usePromise:!0,useWorker:!0});m(_e)})()},[]),x.useEffect(()=>{if(Y){const{xMin:T,yMin:_e,xMax:He,yMax:ke}=Hs(d.current),[Ve,y]=[He-T,ke-_e],B=w.filter(J=>Ve*J/100>p.width&&y*J/100>p.height);v(B)}},[Y]);const ot=()=>{i&&E.event(Ie.DOWNLOAD_PARAM,s?{"#nodes":d.current.order,"#edges":d.current.size}:{}),zt("RMP_".concat(new Date().valueOf(),".json"),"application/json",Ys(n))},Le=async()=>{ye(!0),i&&E.event(Ie.DOWNLOAD_IMAGES,s?{numberOfNodes:d.current.order,numberOfEdges:d.current.size}:{});const{elem:T,width:_e,height:He}=await Ln(d.current,Te,Oe,o,l),ke=T.outerHTML.replace(/&nbsp;/g," ");if(u==="svg"){zt("RMP_".concat(new Date().valueOf(),".svg"),"image/svg+xml",ke),ye(!1);return}if(Fe){window.parent.__TAURI__.core.invoke("render_image",{svgString:ke,scale:j,isTransparent:O,isSystemFontsOnly:Oe}).then(()=>ye(!1));return}document.body.appendChild(T);const Ve="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(ke)));document.body.removeChild(T),T.remove();const y=document.createElement("canvas"),[B,J]=[_e*j/100,He*j/100];y.width=B,y.height=J;const X=y.getContext("2d");O||(X.fillStyle=t,X.fillRect(0,0,B,J));const gt=new Image;gt.onload=()=>{setTimeout(()=>{X.drawImage(gt,0,0,B,J),y.toBlob(Vt=>{if(ye(!1),!Vt){r(lt({status:"error",message:c("header.download.imageTooBig")}));return}Pn("RMP_".concat(new Date().valueOf(),".png"),Vt)},"image/png")},Ks()?2e3:0)},gt.src=Ve};return e.jsxs(Pt,{id:"download",children:[e.jsx(Dt,{as:le,size:"sm",variant:"ghost",icon:e.jsx(gs,{})}),e.jsxs(Bt,{children:[e.jsx(xe,{icon:e.jsx(Vs,{}),onClick:ot,children:c("header.download.config")}),e.jsxs(xe,{icon:e.jsx(Fs,{}),onClick:()=>we(!0),children:[c("header.download.2rmg.title"),e.jsx(me,{ml:"1",colorScheme:"green",children:"New"})]}),e.jsx(xe,{icon:e.jsx(Zs,{}),onClick:()=>je(!0),children:c("header.download.image")})]}),e.jsxs(re,{size:"xl",isOpen:Y,onClose:()=>je(!1),children:[e.jsx(ee,{}),e.jsxs(ie,{children:[e.jsx(te,{children:c("header.download.image")}),e.jsx(ae,{}),e.jsxs(se,{children:[e.jsx(Ne,{fields:P}),u==="svg"&&e.jsx(Ne,{fields:V}),u==="png"&&e.jsx(Ne,{fields:Z}),e.jsx("br",{}),e.jsx(xt,{isChecked:Oe,isDisabled:u==="svg"&&l===1.1,onChange:T=>de(T.target.checked),children:e.jsx(f,{children:c("header.download.isSystemFontsOnly")})}),e.jsx(xt,{id:"share_info",isChecked:Te,onChange:T=>R(T.target.checked),children:e.jsxs(f,{children:[c("header.download.shareInfo1"),e.jsxs(L,{color:"teal.500",onClick:()=>window.open("https://railmapgen.github.io/rmp","_blank"),children:[c("header.about.rmp")," ",e.jsx(U,{as:W})]}),c("header.download.shareInfo2")]})}),e.jsx(xt,{id:"agree_terms",isChecked:st,onChange:T=>Ue(T.target.checked),children:e.jsxs(f,{children:[c("header.download.termsAndConditionsInfo"),e.jsxs(L,{color:"teal.500",onClick:()=>be(!0),children:[c("header.download.termsAndConditions")," ",e.jsx(U,{as:W})]}),c("header.download.period")]})}),u==="png"&&A.includes(j)&&!Fe&&e.jsxs(vt,{status:"error",mt:"4",children:[e.jsx(At,{}),e.jsxs(_,{children:[e.jsx(Ft,{children:c("header.download.disabledScaleOptions")}),e.jsx(Zt,{children:e.jsx(Mt,{i18nKey:"header.download.disabledScaleOptionsSolution",components:{link1:e.jsx(L,{color:"teal.500",textDecoration:"underline",cursor:"pointer",href:"https://afdian.com/item/9c8b220c614311efab2d52540025c377",target:"_blank"}),link2:e.jsx(L,{color:"teal.500",textDecoration:"underline",cursor:"pointer",href:oo()})}})})]})]}),u==="png"&&A.includes(j)&&Fe&&!a&&e.jsxs(vt,{status:"error",mt:"4",children:[e.jsx(At,{}),e.jsxs(_,{children:[e.jsx(Ft,{children:c("header.download.disabledScaleOptions")}),e.jsx(Zt,{children:c("header.settings.pro")})]})]})]}),e.jsx(ce,{children:e.jsx(Ot,{children:e.jsx(N,{id:"download_button",colorScheme:"teal",variant:"outline",size:"sm",isDisabled:!st||u==="png"&&A.includes(j)&&!Fe||u==="png"&&A.includes(j)&&Fe&&!a,isLoading:ut,onClick:Le,children:c("header.download.confirm")})})}),e.jsx(no,{isOpen:$e,onClose:()=>be(!1)})]})]}),e.jsx(to,{isOpen:nt,onClose:()=>we(!1)})]})}function Os(t){const{isOpen:r,onClose:a,onConfirm:s}=t,{t:o}=H(),n=x.useRef(null);return e.jsx(Ms,{isOpen:r,leastDestructiveRef:n,onClose:a,children:e.jsx(ee,{children:e.jsxs(zs,{children:[e.jsx(te,{fontSize:"lg",fontWeight:"bold",children:o("header.open.confirmOverwrite.title")}),e.jsx(se,{children:o("header.open.confirmOverwrite.body")}),e.jsxs(ce,{children:[e.jsx(N,{ref:n,onClick:a,children:o("cancel")}),e.jsx(N,{id:"confirm_overwrite",colorScheme:"red",onClick:s,ml:3,children:o("header.open.confirmOverwrite.overwrite")})]})]})})})}const io=(t,{info_panel_type:r,line_num:a,stn_list:s,style:o,theme:n},i,c,d)=>{const u=Object.fromEntries(Object.keys(s).filter(l=>!["linestart","lineend"].includes(l)).map(l=>[l,"stn_".concat(Tt(10))]));Object.entries(s).filter(([l,g])=>!["linestart","lineend"].includes(l)).forEach(([l,g])=>{const p=t.filterNodes((m,j)=>Object.values(D).includes(j.type)&&j[j.type].names[0]===g.localisedName.zh);p.length!==0&&(u[l]=p[0])});const b=[["linestart",-1,0]],h={};for(;b.length;){const[l,g,p]=b.shift();s[l].children.filter(j=>j!="lineend").forEach((j,S)=>{const w=Math.max(S,p+S);h[j]={x:g*150,y:w*75},b.push([j,g+1,w])})}Object.entries(s).filter(([l,g])=>!["linestart","lineend"].includes(l)).filter(([l,g])=>t.filterNodes((p,m)=>Object.values(D).includes(m.type)&&m[m.type].names[0]===g.localisedName.zh).length===0).map(([l,g])=>{var w,C,A;let p=D.ShmetroBasic;const m=g.transfer.groups,j=m.map(v=>{var O;return(O=v.lines)!=null?O:[]}).flat();o===ve.SHMetro?j.length>0?p=D.ShmetroInt:r===Ut.sh2020?p=D.ShmetroBasic2020:p=D.ShmetroBasic:o===ve.GZMTR?j.length>0?p=D.GzmtrInt:p=D.GzmtrBasic:o===ve.MTR&&(p=D.MTR);const S={...structuredClone(Qe[p].defaultAttrs),names:[(w=g.localisedName.zh)!=null?w:"",(C=g.localisedName.en)!=null?C:""]};return p===D.ShmetroBasic2020?S.color=n:p===D.GzmtrBasic?(S.color=n,S.lineCode=a,S.stationCode=g.num):p===D.GzmtrInt?S.transfer=m.map((v,O)=>{var P,V;const k=(V=(P=v.lines)==null?void 0:P.map(Z=>{var Y;return[...(Y=Z.theme)!=null?Y:n,"1","01"]}))!=null?V:[];return O===0?[[...n,a,g.num],...k]:k}):p===D.MTR&&((A=m[0].lines)!=null&&A.length?S.transfer=[[[...n,"",""],...m[0].lines.map(v=>{var O;return[...(O=v.theme)!=null?O:n,"",""]})]]:S.transfer=[[]]),{node:u[l],attr:{visible:!0,zIndex:0,x:i+h[l].x,y:c+h[l].y,type:p,[p]:S}}}).forEach(({node:l,attr:g})=>t.addNode(l,g)),Object.entries(s).filter(([l,g])=>!["linestart","lineend"].includes(l)).forEach(([l,g])=>{g.children.filter(p=>!["linestart","lineend"].includes(p)).forEach(p=>{const m=Xe.Diagonal,[j,S]=[u[l],u[p]],w=d?ms(t,m,j,S,"from"):-1;t.addDirectedEdgeWithKey("line_".concat(Tt(10)),j,S,{visible:!0,zIndex:0,type:m,[Xe.Diagonal]:structuredClone(Wt[Xe.Diagonal].defaultAttrs),style:ct.SingleColor,[ct.SingleColor]:{color:n},reconcileId:"",parallelIndex:w})})})},ao="rmg-bridge--",lo={h:500,maxH:"70%","& iframe":{h:"100%",w:"100%"}};function co(t){const{isOpen:r,onClose:a}=t,{t:s}=H(),{preference:{autoParallel:o}}=G(S=>S.app),{svgViewBoxZoom:n,svgViewBoxMin:i}=G(S=>S.param),c=F(),d=E.isAllowAnalytics(),u=Gt(),{height:b,width:h}=$t(u),l=it.useRef(window.graph),[g]=it.useState(crypto.randomUUID()),p="/rmg/#/import?"+new URLSearchParams({parentComponent:E.getAppName(),parentId:g}),m=it.useCallback(()=>{c(Q()),c(K()),c(oe(l.current.export()))},[c,Q,K,oe,l]),j=S=>{try{d&&E.event(Ie.IMPORT_RMG_PARAM,{});const w=i.x+h*n/100/3,C=i.y+b*n/100/3;io(l.current,S,w,C,o),m()}catch(w){c(lt({status:"error",message:s("header.open.unknownError")})),console.error("OpenActions.handleUploadRMG():: Unknown error occurred while parsing the RMG project",w)}finally{a()}};return it.useEffect(()=>{const S=new BroadcastChannel(ao+g);return S.onmessage=w=>{const{event:C,data:A}=w.data;console.log("[rmp] Received event from RMG app clip:",C),C==="CLOSE"?a():C==="IMPORT"&&j(A)},()=>S.close()},[i.x,i.y,n,b,h,o]),e.jsx(xs,{isOpen:r,onClose:a,sx:lo,children:e.jsx("iframe",{src:p,loading:"lazy"})})}const ho="RMP_GALLERY_CHANNEL",po="OPEN_TEMPLATE",ss=new BroadcastChannel(ho),uo={h:"80%",w:"80%","& iframe":{h:"100%",w:"100%"},"& div":{h:"100%",w:"100%"}};function go(t){const{isOpen:r,onClose:a}=t,{t:s}=H(),o=F(),{isOpen:n,onOpen:i,onClose:c}=as(),[d,u]=x.useState(null),{telemetry:{project:b}}=G(w=>w.app),h=E.isAllowAnalytics(),l=x.useRef(window.graph),g=x.useCallback(()=>{o(Q()),o(K()),o(oe(l.current.export()))},[o,Q,K,oe,l]),p=async w=>{const{version:C,...A}=JSON.parse(await fs(JSON.stringify(w)));o(kt()),l.current.clear(),l.current.import(A.graph),g();const{svgViewBoxZoom:v,svgViewBoxMin:O}=A;typeof v=="number"&&o(Ge(v)),typeof O.x=="number"&&typeof O.y=="number"&&o(qe(O))},m=async()=>{d&&await p(d),c(),u(null)},j=async(w,C)=>{var O;const A=C?"https://".concat(C):"",v=await((O=(await Promise.allSettled([fetch("".concat(A,"/rmp-gallery/resources/real_world/").concat(w,".json")),fetch("".concat(A,"/rmp-gallery/resources/fantasy/").concat(w,".json"))])).filter(k=>k.status==="fulfilled").find(k=>k.value.status===200))==null?void 0:O.value.json());if(v){if(u(v),i(),h){const k={id:w};b&&C&&(k.host=C),E.event(Ie.IMPORT_WORK_FROM_GALLERY,k)}E.sendNotification({title:s("header.open.importOK",{id:w}),message:s("header.open.importOKContent"),type:"success",duration:9e3})}else E.sendNotification({title:s("header.open.importFail",{id:w}),message:s("header.open.importFailContent"),type:"error",duration:9e3})},S=async w=>{try{const C=await fetch("".concat(Js,"/").concat(w));if(C.status!==200)throw new Error(s("header.open.importFailContent"));const A=await C.json();u(A),i(),h&&E.event(Ie.IMPORT_WORK_FROM_SHARE,{share:w}),E.sendNotification({title:s("header.open.importOK",{id:w}),message:s("header.open.importOKContent"),type:"success",duration:9e3})}catch(C){E.sendNotification({title:s("header.open.importFail",{id:w}),message:C.message,type:"error",duration:9e3})}};return x.useEffect(()=>{const C=new URL(window.location.href).searchParams;if(C.size>0){const A=C.keys().next().value,v=A.indexOf("."),O=A.substring(0,v===-1?void 0:v);let k;v!==-1&&(k=A.substring(v+1)),k==="org"?S(O):j(O,k),E.updateAppMetadata({search:""})}},[]),x.useEffect(()=>(ss.onmessage=w=>{const{event:C,data:A}=w.data;C===po&&(j(A),a())},()=>ss.close()),[]),e.jsxs(e.Fragment,{children:[e.jsxs(xs,{isOpen:r,onClose:a,size:"full",sx:uo,children:[e.jsx("iframe",{src:"/rmp-gallery/",loading:"lazy"}),e.jsx(ls,{onClick:a,position:"fixed",top:"5px",right:"15px"})]}),e.jsx(Os,{isOpen:n,onClose:c,onConfirm:m})]})}function mo(){const t=F(),{t:r}=H(),{isOpen:a,onOpen:s,onClose:o}=as(),[n,i]=x.useState(null),c=Gt(),{height:d}=$t(c),u=x.useRef(window.graph),b=x.useRef(null),[h,l]=x.useState(!1),[g,p]=x.useState(!1),m=x.useCallback(()=>{t(Q()),t(K()),t(oe(u.current.export()))},[t,Q,K,oe,u]),j=()=>{t(kt()),u.current.clear(),t(Ge(100)),t(qe({x:0,y:0})),m()},S=async v=>{const{version:O,...k}=JSON.parse(await fs(v));t(kt()),u.current.clear(),u.current.import(k.graph),m();const{svgViewBoxZoom:P,svgViewBoxMin:V}=k;typeof P=="number"&&t(Ge(P)),typeof V.x=="number"&&typeof V.y=="number"&&t(qe(V))},w=async()=>{if(n){await S(n);const v=await Xt();if(n.length===v.length){t(qe({x:-10,y:-13}));const O=Math.max(0,Math.min(400,-.132*d+117.772));t(Ge(O)),E.event(Ie.LOAD_TUTORIAL,{})}}o(),i(null)},C=async v=>{var k;const O=(k=v.target.files)==null?void 0:k[0];if(console.log("OpenActions.handleUpload():: received file",O),(O==null?void 0:O.type)!=="application/json")t(lt({status:"error",message:r("header.open.invalidType")})),console.error("OpenActions.handleUpload():: Invalid file type! Only file in JSON format is accepted.");else try{const P=await xo(O);i(P),s()}catch(P){t(lt({status:"error",message:r("header.open.unknownError")})),console.error("OpenActions.handleUpload():: Unknown error occurred while parsing the uploaded file",P)}v.target.value=""},A=async()=>{const v=await Xt();i(v),s()};return x.useEffect(()=>{const v=async O=>{const{type:k,key:P,from:V}=O.data;if(k===en.SAVE_CHANGED&&P===qt.PARAM&&V==="rmt"){tn.debug("Received save changed event on key: ".concat(P));const Z=localStorage.getItem(qt.PARAM);if(!Z)return;await S(Z)}};return Kt.addEventListener("message",v),()=>Kt.removeEventListener("message",v)},[]),e.jsxs(e.Fragment,{children:[e.jsxs(Pt,{children:[e.jsx(Dt,{as:le,size:"sm",variant:"ghost",icon:e.jsx(Jt,{})}),e.jsxs(Bt,{children:[e.jsx(xe,{icon:e.jsx(Xs,{}),onClick:j,children:r("header.open.new")}),e.jsx("input",{id:"upload_project",ref:b,type:"file",accept:".json",hidden:!0,onChange:C,"data-testid":"file-upload"}),e.jsx(xe,{icon:e.jsx(Jt,{}),onClick:()=>{var v;return(v=b==null?void 0:b.current)==null?void 0:v.click()},children:r("header.open.config")}),e.jsx(xe,{icon:e.jsx(qs,{}),onClick:()=>l(!0),children:r("header.open.projectRMG")}),e.jsxs(xe,{icon:e.jsx(W,{}),onClick:()=>p(!0),children:[r("header.open.gallery"),e.jsx(me,{ml:"1",colorScheme:"green",children:"New"})]}),e.jsx(xe,{icon:e.jsx(Qs,{}),onClick:A,children:r("header.open.tutorial")})]}),e.jsx(co,{isOpen:h,onClose:()=>l(!1)}),e.jsx(go,{isOpen:g,onClose:()=>p(!1)})]}),e.jsx(Os,{isOpen:a,onClose:o,onConfirm:w})]})}const xo=t=>new Promise(r=>{const a=new FileReader;a.onloadend=()=>r(a.result),a.readAsText(t)}),fo=()=>{const[t,r]=x.useState(!1),{t:a}=H(),s=F(),o=x.useRef(window.graph),n=Gt(),{width:i,height:c}=$t(n),[d,u]=x.useState([]);x.useEffect(()=>{t&&u(o.current.nodes().filter(h=>h.startsWith("stn")).map(h=>{const l=o.current.getNodeAttributes(h),g=l.type,p=l[g].names.join("/");return{id:h,value:p}}))},[t]);const b=h=>{s(on(new Set([h])));const l=Math.max(0,Math.min(400,-.132*c+117.772)),{x:g,y:p}=rn((i-300)/2,c/2,l,{x:-o.current.getNodeAttribute(h,"x"),y:-o.current.getNodeAttribute(h,"y")});s(Ge(l)),s(qe({x:-g,y:-p}))};return e.jsxs(cs,{isOpen:t,onOpen:()=>r(!0),onClose:()=>r(!1),children:[e.jsx(ds,{children:e.jsx(le,{"aria-label":"zoom",variant:"ghost",size:"sm",icon:e.jsx(sn,{}),onClick:()=>r(!t)})}),e.jsx(hs,{children:e.jsx(ps,{children:e.jsx(nn,{label:a("header.search"),children:e.jsx(js,{data:d,displayHandler:h=>e.jsx(me,{children:h.value}),filter:(h,l)=>l.value.toLowerCase().includes(h.toLowerCase())||Object.values(l.value).some(g=>g.toLowerCase().includes(h.toLowerCase())),value:"",onChange:h=>b(h.id)})})})})]})},ns=[D.ShmetroBasic2020,D.LondonTubeBasic,D.ShanghaiSuburbanRailway],jo=(t,r,a)=>{const s=t.getNodeAttribute(r,"type"),o=structuredClone(t.getNodeAttribute(r,s).names);for(let i=0;i<Math.abs(Qe[a].defaultAttrs.names.length-o.length);i++)Qe[a].defaultAttrs.names.length>o.length?o.push("Stn"):o.pop();const n={...Qe[a].defaultAttrs,names:o};(!Object.values(ns).includes(s)||!Object.values(ns).includes(a))&&(n.nameOffsetX=t.getNodeAttribute(r,s).nameOffsetX,n.nameOffsetY=t.getNodeAttribute(r,s).nameOffsetY),Ce.has(a)&&Ce.has(s)&&(n.color=structuredClone(t.getNodeAttribute(r,s).color)),t.removeNodeAttribute(r,s),t.mergeNodeAttributes(r,{type:a,[a]:n})},bo=(t,r,a,s)=>s.filter(o=>r==="any"||t.getNodeAttribute(o,"type")===r).forEach(o=>{jo(t,o,a)}),yo=(t,r,a,s)=>{const o=t.getEdgeAttribute(r,"type"),n=t.getEdgeAttribute(r,"style");if(dt[n].metadata.supportLinePathType.includes(a)){const i=structuredClone(Wt[a].defaultAttrs);let c=-1;if(s&&a!==Xe.Simple){const[d,u]=t.extremities(r),b=i.startFrom;c=ms(t,a,d,u,b)}t.setEdgeAttribute(r,"parallelIndex",c),t.removeEdgeAttribute(r,o),t.mergeEdgeAttributes(r,{type:a,[a]:i})}},wo=(t,r,a,s,o)=>s.filter(n=>r==="any"||t.getEdgeAttribute(n,"type")===r).forEach(n=>{yo(t,n,a,o)}),So=(t,r,a,s)=>{const o=t.getEdgeAttribute(r,"type"),n=t.getEdgeAttribute(r,"style");if(dt[a].metadata.supportLinePathType.includes(o)){const i=t.getEdgeAttribute(r,"zIndex"),c=t.getEdgeAttribute(r,n);t.removeEdgeAttribute(r,n);const d=structuredClone(dt[a].defaultAttrs);Ce.has(n)&&Ce.has(a)?d.color=c.color:Ce.has(a)&&s&&(d.color=s),t.mergeEdgeAttributes(r,{style:a,[a]:d}),a===ct.River?t.setEdgeAttribute(r,"zIndex",-5):t.setEdgeAttribute(r,"zIndex",i!=null?i:0)}},Co=(t,r,a,s,o)=>o.filter(n=>r==="any"||t.getEdgeAttribute(n,"style")===r).forEach(n=>{So(t,n,a,s)}),vo=(t,r,a,s)=>s.filter(o=>Ce.has(t.getEdgeAttribute(o,"style"))).forEach(o=>{const n=t.getEdgeAttributes(o),i=n[n.style].color;(r==="any"||i[0]==r[0]&&i[1]==r[1]&&i[2]==r[2]&&i[3]==r[3])&&t.mergeEdgeAttributes(o,{[n.style]:{color:a}})}),Ao=(t,r,a,s,o)=>{[...s,...o].forEach(n=>{const i=t.getNodeAttributes(n).type,c=t.getNodeAttribute(n,i);if(c.color!==void 0){const d=c.color;(r==="any"||d[0]==r[0]&&d[1]==r[1]&&d[2]==r[2]&&d[3]==r[3])&&(c.color=a)}t.mergeNodeAttributes(n,{[i]:c})})},Oo=(t,r,a,s,o)=>{[...r,...a].forEach(n=>{t.setNodeAttribute(n,"zIndex",o)}),s.forEach(n=>{t.setEdgeAttribute(n,"zIndex",o)})},To=t=>{const{isOpen:r,onClose:a,isSelect:s,filter:o}=t,{t:n}=H(),i=F(),{selected:c}=G(y=>y.runtime),{preference:{autoParallel:d}}=G(y=>y.app),{activeSubscriptions:u}=G(y=>y.account),b=x.useCallback(()=>{i(Q()),i(K()),i(oe(h.current.export()))},[i,Q,K,oe]),h=x.useRef(window.graph),l={any:n("header.settings.procedures.changeType.any"),...Object.fromEntries(Object.entries(Wt).map(([y,B])=>[y,n(B.metadata.displayName).toString()]))},g={any:n("header.settings.procedures.changeType.any"),...Object.fromEntries(Object.entries(dt).map(([y,B])=>[y,n(B.metadata.displayName).toString()]))},p={any:n("header.settings.procedures.changeType.any"),...Object.fromEntries(Object.entries(Qe).map(([y,B])=>[y,n(B.metadata.displayName).toString()]))},m={id:"any",theme:[us.Other,"other","#ffffff",ht.black],value:n("header.settings.procedures.changeType.any")},[j,S]=x.useState(!1),[w,C]=x.useState(0),[A,v]=x.useState(!1),[O,k]=x.useState("any"),[P,V]=x.useState(D.ShmetroBasic),[Z,Y]=x.useState(!1),[je,$e]=x.useState("any"),[be,Oe]=x.useState(ct.SingleColor),[de,Te]=x.useState(!1),[R,st]=x.useState("any"),[Ue,ut]=x.useState(Xe.Diagonal),[ye,nt]=x.useState(!1),[we,ot]=x.useState(m),{theme:Le,requestThemeChange:T}=bs(),[_e,He]=x.useState([]),ke=[{id:"changeZIndex",title:n("header.settings.procedures.changeZIndex"),onClose:()=>S(!j),field:[{type:"select",label:n("panel.details.info.zIndex"),value:w,options:Object.fromEntries(Array.from({length:11},(y,B)=>[B-5,(B-5).toString()])),onChange:y=>C(Number(y))}]},{id:"changeStationType",title:n("header.settings.procedures.changeStationType.title"),onClose:()=>v(!A),field:[{type:"select",label:n("header.settings.procedures.changeStationType.changeFrom"),options:p,value:O,disabledOptions:[P],onChange:y=>k(y)},{type:"select",label:n("header.settings.procedures.changeStationType.changeTo"),options:p,value:P,disabledOptions:["any",O],onChange:y=>V(y)}]},{id:"changeLineStyleType",title:n("header.settings.procedures.changeLineStyleType.title"),onClose:()=>Y(!Z),field:[{type:"select",label:n("header.settings.procedures.changeLineStyleType.changeFrom"),options:g,value:je,disabledOptions:[be],onChange:y=>$e(y)},{type:"select",label:n("header.settings.procedures.changeLineStyleType.changeTo"),options:g,value:be,disabledOptions:["any",je],onChange:y=>Oe(y)}]},{id:"changeLinePathType",title:n("header.settings.procedures.changeLinePathType.title"),onClose:()=>Te(!de),field:[{type:"select",label:n("header.settings.procedures.changeLinePathType.changeFrom"),options:l,value:R,disabledOptions:[Ue],onChange:y=>st(y)},{type:"select",label:n("header.settings.procedures.changeLinePathType.changeTo"),options:l,value:Ue,disabledOptions:["any","simple",R],onChange:y=>ut(y)}]},{id:"changeColor",title:n("header.settings.procedures.changeColor.title"),onClose:()=>nt(!ye),field:[{type:"custom",label:n("header.settings.procedures.changeColor.changeFrom"),component:e.jsx(js,{data:_e,displayHandler:y=>e.jsx(_t,{name:y.value,fg:y.theme[3],bg:y.theme[2],title:y.theme[1],sx:{display:"inline-block",overflow:"hidden",textOverflow:"ellipsis"}}),filter:(y,B)=>B.id.toLowerCase().includes(y.toLowerCase())||Object.values(B.id).some(J=>J.toLowerCase().includes(y.toLowerCase())),value:we.value,onChange:y=>ot(y)})},{type:"custom",label:n("header.settings.procedures.changeColor.changeTo"),component:e.jsx(ys,{theme:Le,onClick:T})}]}];x.useEffect(()=>{r&&(S(!1),v(!1),Y(!1),Te(!1),nt(!1),C(0),He([m,...Dn(h.current,s?[...c].filter(y=>y.startsWith("stn")||y.startsWith("misc_node")):h.current.nodes(),s?[...c].filter(y=>y.startsWith("line")):h.current.edges()).map(y=>({id:y.toString(),theme:y,value:y[1]==="other"?y[2]:y[1]}))]),ot(m))},[r]);const Ve=()=>{const y=o!=null&&o.includes("station")?[...c].filter(X=>X.startsWith("stn")):s?[]:h.current.filterNodes(X=>X.startsWith("stn")),B=o!=null&&o.includes("misc-node")?[...c].filter(X=>X.startsWith("misc_node")):s?[]:h.current.filterNodes(X=>X.startsWith("misc_node")),J=s?[...c].filter(X=>X.startsWith("line")):h.current.edges();(!o||o.includes("station"))&&A&&bo(h.current,O,P,y),(!o||o.includes("line"))&&Z&&Co(h.current,je,be,Le,J),(!o||o.includes("line"))&&de&&wo(h.current,R,Ue,J,d),ye&&((!o||o.includes("line"))&&vo(h.current,we.id==="any"?"any":we.theme,Le,J),(!o||o.includes("misc-node")||o.includes("station"))&&Ao(h.current,we.id==="any"?"any":we.theme,Le,y,B)),j&&Oo(h.current,y,B,J,w),b(),a()};return e.jsxs(re,{isOpen:r,onClose:a,size:"md",scrollBehavior:"inside",children:[e.jsx(ee,{}),e.jsxs(ie,{children:[e.jsxs(te,{children:[e.jsx(f,{as:"b",fontSize:"xl",children:n(s?"panel.details.multipleSelection.change":"header.settings.procedures.changeType.title")}),e.jsx(ae,{})]}),e.jsx(se,{children:e.jsx(Es,{allowMultiple:!0,children:ke.map(y=>e.jsxs(Rs,{children:[e.jsxs(Ns,{onClick:y.onClose,children:[e.jsx(_,{as:"span",flex:"1",textAlign:"left",children:e.jsx(f,{as:"b",fontSize:"md",children:y.title})}),e.jsx(Is,{})]}),e.jsx(Ls,{pb:4,children:e.jsx(Ne,{fields:y.field,minW:270})})]},y.id))})}),e.jsxs(ce,{children:[e.jsx(N,{colorScheme:"blue",variant:"outline",mr:"1",onClick:a,children:n("cancel")}),e.jsx(Ee,{label:n("header.settings.pro"),isOpen:!u.RMP_CLOUD,children:e.jsx(N,{colorScheme:"red",mr:"1",onClick:Ve,isDisabled:!u.RMP_CLOUD||!j&&!A&&!Z&&!de&&!ye,children:n("apply")})})]})]})]})},_o=t=>{const{isOpen:r,onClose:a}=t,s=F(),{t:o}=H(),n=x.useRef(window.graph),{theme:i,requestThemeChange:c}=bs(),d=()=>{n.current.filterEdges((u,b,h,l,g,p,m)=>Ce.has(b.style)&&JSON.stringify(b[b.style].color)===JSON.stringify(i)).forEach(u=>n.current.dropEdge(u)),s(K()),s(oe(n.current.export())),a()};return e.jsxs(re,{isOpen:r,onClose:a,size:"xl",scrollBehavior:"inside",trapFocus:!1,children:[e.jsx(ee,{}),e.jsxs(ie,{children:[e.jsx(te,{children:o("header.settings.procedures.removeLines.title")}),e.jsx(ae,{}),e.jsxs(se,{children:[o("header.settings.procedures.removeLines.content"),e.jsx(ys,{theme:i,onClick:c})]}),e.jsxs(ce,{children:[e.jsx(N,{colorScheme:"blue",variant:"outline",mr:"1",onClick:a,children:o("cancel")}),e.jsx(N,{colorScheme:"red",onClick:d,children:o("remove")})]})]})]})},ko=t=>{const{isOpen:r,onClose:a}=t,s=F(),{t:o}=H(),n=x.useRef(window.graph),[i,c]=x.useState(1),d=[{type:"input",label:o("header.settings.procedures.scale.factor"),value:i.toString(),variant:"number",onChange:b=>c(Number(b)),minW:"full"}],u=()=>{n.current.forEachNode((b,h)=>{n.current.updateNodeAttribute(b,"x",l=>(l!=null?l:0)*i),n.current.updateNodeAttribute(b,"y",l=>(l!=null?l:0)*i)}),s(Q()),s(K()),s(oe(n.current.export())),a()};return e.jsxs(re,{isOpen:r,onClose:a,size:"xl",scrollBehavior:"inside",children:[e.jsx(ee,{}),e.jsxs(ie,{children:[e.jsx(te,{children:o("header.settings.procedures.scale.title")}),e.jsx(ae,{}),e.jsxs(se,{children:[o("header.settings.procedures.scale.content"),e.jsx(Ne,{fields:d})]}),e.jsxs(ce,{children:[e.jsx(N,{colorScheme:"blue",variant:"outline",mr:"1",onClick:a,children:o("cancel")}),e.jsx(N,{colorScheme:"red",onClick:u,children:o("apply")})]})]})]})},Mo=t=>{const{isOpen:r,onClose:a}=t,s=F(),{t:o}=H(),n=x.useRef(window.graph),[i,c]=x.useState(0),[d,u]=x.useState(0),b=[{type:"input",label:o("header.settings.procedures.translate.x"),value:i.toString(),variant:"number",onChange:l=>c(Number(l)),minW:"full"},{type:"input",label:o("header.settings.procedures.translate.y"),value:d.toString(),variant:"number",onChange:l=>u(Number(l)),minW:"full"}],h=()=>{n.current.forEachNode((l,g)=>{n.current.updateNodeAttribute(l,"x",p=>(p!=null?p:0)+i),n.current.updateNodeAttribute(l,"y",p=>(p!=null?p:0)+d)}),s(Q()),s(K()),s(oe(n.current.export())),a()};return e.jsxs(re,{isOpen:r,onClose:a,size:"xl",scrollBehavior:"inside",children:[e.jsx(ee,{}),e.jsxs(ie,{children:[e.jsx(te,{children:o("header.settings.procedures.translate.title")}),e.jsx(ae,{}),e.jsxs(se,{children:[o("header.settings.procedures.translate.content"),e.jsx(Ne,{fields:b})]}),e.jsxs(ce,{children:[e.jsx(N,{colorScheme:"blue",variant:"outline",mr:"1",onClick:a,children:o("cancel")}),e.jsx(N,{colorScheme:"red",onClick:h,children:o("apply")})]})]})]})},zo=t=>{const{isOpen:r,onClose:a}=t,s=F(),{preference:{unlockSimplePathAttempts:o}}=G(d=>d.app),{activeSubscriptions:n}=G(d=>d.account),{t:i}=H(),c=()=>{s(an(-1))};return e.jsxs(re,{isOpen:r,onClose:a,size:"5xl",scrollBehavior:"inside",children:[e.jsx(ee,{}),e.jsxs(ie,{children:[e.jsx(te,{children:i("header.settings.procedures.unlockSimplePath.title")}),e.jsx(ae,{}),e.jsxs(se,{children:[e.jsx(f,{mb:"2",children:i("header.settings.procedures.unlockSimplePath.content1")}),e.jsx(f,{mb:"2",children:i("header.settings.procedures.unlockSimplePath.content2")}),e.jsx(f,{mb:"2",children:i("header.settings.procedures.unlockSimplePath.content3")})]}),e.jsx(ce,{children:e.jsx(Ee,{label:i("header.settings.pro"),isOpen:!n.RMP_CLOUD&&o>=0,children:e.jsx(N,{onClick:c,isDisabled:!n.RMP_CLOUD||o<0,children:o>=0?i("header.settings.procedures.unlockSimplePath.check"):i("header.settings.procedures.unlockSimplePath.unlocked")})})})]})]})},Eo=t=>{const{isOpen:r,onClose:a}=t,s=F(),o=Ps(),{t:n}=H(),i=x.useRef(window.graph),[c,d]=x.useState(!1),u=async()=>{d(!0);const b=JSON.stringify(i.current.export());try{const h=await Io(b);i.current.clear(),i.current.import(h),s(Q()),s(K()),s(oe(i.current.export())),o({title:n("header.settings.procedures.updateColor.success"),status:"success",duration:9e3,isClosable:!0})}catch(h){console.error("[rmp] Error in updating all colors: ".concat(h)),o({title:n("header.settings.procedures.updateColor.error",{e:h}),status:"error",duration:9e3,isClosable:!0})}d(!1),a()};return e.jsxs(re,{isOpen:r,onClose:a,size:"xl",scrollBehavior:"inside",children:[e.jsx(ee,{}),e.jsxs(ie,{children:[e.jsx(te,{children:n("header.settings.procedures.updateColor.title")}),e.jsx(ae,{}),e.jsx(se,{children:e.jsx(f,{children:n("header.settings.procedures.updateColor.content")})}),e.jsxs(ce,{children:[e.jsx(N,{colorScheme:"blue",variant:"outline",mr:"1",onClick:a,children:n("cancel")}),e.jsx(N,{colorScheme:"red",onClick:u,isLoading:c,children:n("apply")})]})]})]})},os=t=>t.length>=4&&t.every(r=>typeof r=="string")&&!!t[2].match(/^#[0-9a-fA-F]{6}$/)&&Object.values(ht).includes(t[3]),Ro=t=>{const r=[],a=(s,o)=>{if(Array.isArray(s)&&os(s)){r.push({path:o||"",value:s});return}for(const n in s){const i=s[n],c=o?"".concat(o,".").concat(n):n;Array.isArray(i)?os(i)?r.push({path:c,value:i}):i.forEach((d,u)=>a(d,"".concat(c,".").concat(u))):i&&typeof i=="object"&&a(i,c)}};return a(t),r},No=(t,r,a)=>{const s=r.split(".");let o=t;for(let n=0;n<s.length-1;n++)o=o[s[n]];o[s[s.length-1]]=a},Io=async t=>{const r=JSON.parse(t),a=new Date().getTime(),s=Ro(r);console.log("[rmp] Found all themes pending for update",s);const o=1e4;let n,i=!1;const c=new Promise((d,u)=>{n=setTimeout(()=>{i=!0,u("Executing time exceeds ".concat(o,"ms"))},o),(async()=>{for(const{path:b,value:h}of s){if(i)throw new Error("Update aborted");const[l,g,p,m,...j]=h,S=await ln([l,g,p,m]);No(r,b,[...S,...j])}})().then(d).catch(u)});try{return await c,console.log("[rmp] Themes update completed, elapsed time ".concat((new Date().getTime()-a)/1e3," sec")),r}finally{clearTimeout(n)}},rs=1,Lo=()=>{const t=F(),{state:r,token:a}=G(m=>m.account),{count:{stations:s,miscNodes:o,masters:n,lines:i,parallel:c}}=G(m=>m.runtime),{t:d}=H(),[u,b]=x.useState(!1),[h,l]=x.useState(rs);x.useEffect(()=>{let m;return u&&h>0?m=window.setTimeout(()=>{l(h-1)},1e3):h===0&&b(!1),()=>clearTimeout(m)},[u,h]);const g=()=>{b(!0),l(rs),a&&dn(t,a)},p={"logged-out":d("header.settings.status.subscription.logged-out"),free:d("header.settings.status.subscription.free"),subscriber:d("header.settings.status.subscription.subscriber"),expired:d("header.settings.status.subscription.expired")};return e.jsxs(_,{width:"100%",mb:"3",children:[e.jsx(f,{as:"b",fontSize:"xl",children:d("header.settings.status.title")}),e.jsxs(_,{mt:"3",children:[e.jsxs(_,{mb:"1",children:[e.jsxs(_,{display:"flex",mb:"1",children:[e.jsx(f,{flex:"1",children:d("header.settings.status.count.stations")}),e.jsx(f,{children:s})]}),e.jsxs(_,{display:"flex",mb:"1",children:[e.jsx(f,{flex:"1",children:d("header.settings.status.count.miscNodes")}),e.jsx(f,{children:o})]}),e.jsxs(_,{display:"flex",mb:"1",children:[e.jsx(f,{flex:"1",children:d("header.settings.status.count.masters")}),e.jsx(f,{children:n})]}),e.jsxs(_,{display:"flex",mb:"1",children:[e.jsx(f,{flex:"1",children:d("header.settings.status.count.lines")}),e.jsx(f,{children:i})]}),e.jsxs(_,{display:"flex",mb:"1",children:[e.jsx(f,{flex:"1",children:d("header.settings.status.count.parallel")}),e.jsx(f,{children:c})]})]}),e.jsxs(_,{display:"flex",mb:"1",children:[e.jsxs(f,{flex:"1",children:[d("header.settings.status.subscription.content")," ",p[r]]}),e.jsx(le,{"aria-label":"refresh",variant:"ghost",size:"sm",icon:e.jsx(cn,{}),isDisabled:u,onClick:()=>g()})]})]})]})},ze={width:"100%",justifyContent:"space-between"},ge={fontFamily:"-apple-system"},Po=t=>{const{isOpen:r,onClose:a}=t,{activeSubscriptions:s}=G(R=>R.account),{telemetry:{project:o},preference:{autoParallel:n,randomStationsNames:i,gridLines:c,snapLines:d}}=G(R=>R.app),{keepLastPath:u,count:{parallel:b}}=G(R=>R.runtime),h=F(),{t:l}=H(),g=is("primary.500","primary.300"),[p,m]=x.useState(!1),[j,S]=x.useState(!1),[w,C]=x.useState(!1),[A,v]=x.useState(!1),[O,k]=x.useState(!1),[P,V]=x.useState(!1),[Z,Y]=x.useState(!1),je=E.isAllowAnalytics(),$e=R=>{h(Sn(R))},be=s.RMP_CLOUD?hn:pn,Oe=b>=be,de=!s.RMP_CLOUD,Te=R=>{h(wn(R.target.value))};return e.jsxs(re,{isOpen:r,onClose:a,size:"xl",scrollBehavior:"inside",trapFocus:!1,children:[e.jsx(ee,{}),e.jsxs(ie,{children:[e.jsx(te,{children:l("header.settings.title")}),e.jsx(ae,{}),e.jsx(se,{children:e.jsxs(Ye,{divider:e.jsx($s,{borderColor:"gray.200"}),children:[e.jsx(Lo,{}),e.jsxs(_,{width:"100%",mb:"3",children:[e.jsx(f,{as:"b",fontSize:"xl",children:l("header.settings.preference.title")}),e.jsxs(_,{mt:"3",children:[e.jsxs(_,{display:"flex",mb:"1",children:[e.jsx(f,{flex:"1",children:l("header.settings.preference.keepLastPath")}),e.jsx(De,{isChecked:u,onChange:({target:{checked:R}})=>h(un(R))})]}),e.jsxs(_,{display:"flex",mb:"1",children:[e.jsx(f,{children:l("header.settings.preference.autoParallel")}),e.jsx(me,{ml:"auto",colorScheme:"green",children:"New"}),e.jsx(Ee,{label:l("header.settings.proWithTrial"),children:e.jsx(me,{ml:"1",color:"gray.50",background:"radial-gradient(circle, #3f5efb, #fc466b)",children:"PRO"})}),e.jsx(De,{ml:"1",isDisabled:Oe,isChecked:n,onChange:({target:{checked:R}})=>h(gn(R))})]}),e.jsxs(_,{mb:"1",display:"flex",children:[e.jsx(f,{flex:"1",children:l("header.settings.preference.randomStationNames.title")}),e.jsx(me,{ml:"auto",colorScheme:"green",children:"New"}),e.jsx(Ee,{label:l("header.settings.pro"),children:e.jsx(me,{color:"gray.50",ml:"1",background:"radial-gradient(circle, #3f5efb, #fc466b)",children:"PRO"})}),e.jsxs(Ds,{size:"xs",width:"auto",ml:"1",value:i,onChange:Te,children:[e.jsx("option",{value:"none",children:l("header.settings.preference.randomStationNames.none")}),e.jsx("option",{value:rt.Shmetro,disabled:de,children:l("header.settings.preference.randomStationNames.".concat(rt.Shmetro))}),e.jsx("option",{value:rt.Bjsubway,disabled:de,children:l("header.settings.preference.randomStationNames.".concat(rt.Bjsubway))})]})]}),e.jsxs(_,{display:"flex",mb:"1",children:[e.jsx(f,{flex:"1",children:l("header.settings.preference.gridline")}),e.jsx(De,{isChecked:c,onChange:({target:{checked:R}})=>h(mn(R))})]}),e.jsxs(_,{display:"flex",mb:"1",children:[e.jsx(f,{flex:"1",children:l("header.settings.preference.snapline")}),e.jsx(De,{isChecked:d,onChange:({target:{checked:R}})=>h(xn(R))})]})]})]}),e.jsxs(_,{width:"100%",mb:"3",children:[e.jsx(f,{as:"b",fontSize:"xl",children:l("header.settings.procedures.title")}),e.jsxs(_,{mt:"3",children:[e.jsx(N,{sx:ze,rightIcon:e.jsx(Me,{}),onClick:()=>m(!0),children:l("header.settings.procedures.translate.title")}),e.jsx(Mo,{isOpen:p,onClose:()=>m(!1)}),e.jsx(N,{sx:ze,rightIcon:e.jsx(Me,{}),onClick:()=>S(!0),children:l("header.settings.procedures.scale.title")}),e.jsx(ko,{isOpen:j,onClose:()=>S(!1)}),e.jsxs(N,{sx:ze,rightIcon:e.jsx(Me,{}),onClick:()=>C(!0),children:[l("header.settings.procedures.changeType.title"),e.jsx(Ee,{label:l("header.settings.pro"),children:e.jsx(me,{ml:"1",color:"gray.50",background:"radial-gradient(circle, #3f5efb, #fc466b)",mr:"auto",children:"PRO"})})]}),e.jsx(To,{isOpen:w,onClose:()=>C(!1),isSelect:!1}),e.jsx(N,{sx:ze,rightIcon:e.jsx(Me,{}),onClick:()=>v(!0),children:l("header.settings.procedures.removeLines.title")}),e.jsx(_o,{isOpen:A,onClose:()=>v(!1)}),e.jsx(N,{sx:ze,rightIcon:e.jsx(Me,{}),onClick:()=>k(!0),children:l("header.settings.procedures.updateColor.title")}),e.jsx(Eo,{isOpen:O,onClose:()=>k(!1)}),e.jsxs(N,{sx:ze,rightIcon:e.jsx(Me,{}),onClick:()=>V(!0),children:[l("header.settings.procedures.unlockSimplePath.title"),e.jsx(Ee,{label:l("header.settings.pro"),children:e.jsx(me,{ml:"1",color:"gray.50",background:"radial-gradient(circle, #3f5efb, #fc466b)",mr:"auto",children:"PRO"})})]}),e.jsx(zo,{isOpen:P,onClose:()=>V(!1)}),e.jsx(N,{sx:ze,rightIcon:e.jsx(Me,{}),onClick:()=>Y(!0),children:l("header.settings.procedures.masterManager.title")}),e.jsx(Bn,{isOpen:Z,onClose:()=>Y(!1)})]})]}),e.jsxs(_,{width:"100%",mb:"3",children:[e.jsx(f,{as:"b",fontSize:"xl",children:l("header.settings.shortcuts.title")}),e.jsx(_,{mt:"3",children:e.jsxs(Bs,{children:[e.jsx(Ws,{children:e.jsxs(q,{children:[e.jsx(Yt,{children:l("header.settings.shortcuts.keys")}),e.jsx(Yt,{children:l("header.settings.shortcuts.description")})]})}),e.jsxs(Gs,{children:[e.jsxs(q,{children:[e.jsx(I,{children:e.jsx(M,{children:"f"})}),e.jsx(I,{children:l("header.settings.shortcuts.f")})]}),e.jsxs(q,{children:[e.jsx(I,{children:e.jsx(M,{children:"s"})}),e.jsx(I,{children:l("header.settings.shortcuts.s")})]}),e.jsxs(q,{children:[e.jsx(I,{children:e.jsxs(_,{display:"flex",flexDirection:"row",children:[e.jsx(fn,{}),e.jsx(jn,{}),e.jsx(bn,{}),e.jsx(yn,{})]})}),e.jsx(I,{children:l("header.settings.shortcuts.arrows")})]}),e.jsxs(q,{children:[e.jsx(I,{children:e.jsxs(_,{display:"flex",flexDirection:"row",children:[e.jsx(M,{children:"i"}),e.jsx(M,{children:"j"}),e.jsx(M,{children:"k"}),e.jsx(M,{children:"l"})]})}),e.jsx(I,{children:l("header.settings.shortcuts.ijkl")})]}),e.jsxs(q,{children:[e.jsx(I,{children:Se?e.jsx(M,{sx:ge,children:"⇧"}):e.jsx(M,{children:"shift"})}),e.jsx(I,{children:l("header.settings.shortcuts.shift")})]}),e.jsxs(q,{children:[e.jsx(I,{children:Se?e.jsx(M,{sx:ge,children:"⌥"}):e.jsx(M,{children:"alt"})}),e.jsx(I,{children:l("header.settings.shortcuts.alt")})]}),e.jsxs(q,{children:[e.jsx(I,{children:Se?e.jsx(M,{sx:ge,children:"⌫"}):e.jsx(M,{children:"delete"})}),e.jsx(I,{children:l("header.settings.shortcuts.delete")})]}),e.jsxs(q,{children:[e.jsxs(I,{children:[Se?e.jsx(M,{sx:ge,children:"⌘"}):e.jsx(M,{children:"ctrl"})," + ",e.jsx(M,{children:"x"})]}),e.jsx(I,{children:l("header.settings.shortcuts.cut")})]}),e.jsxs(q,{children:[e.jsxs(I,{children:[Se?e.jsx(M,{sx:ge,children:"⌘"}):e.jsx(M,{children:"ctrl"})," + ",e.jsx(M,{children:"c"})]}),e.jsx(I,{children:l("header.settings.shortcuts.copy")})]}),e.jsxs(q,{children:[e.jsxs(I,{children:[Se?e.jsx(M,{sx:ge,children:"⌘"}):e.jsx(M,{children:"ctrl"})," + ",e.jsx(M,{children:"v"})]}),e.jsx(I,{children:l("header.settings.shortcuts.paste")})]}),e.jsxs(q,{children:[e.jsxs(I,{children:[Se?e.jsx(M,{sx:ge,children:"⌘"}):e.jsx(M,{children:"ctrl"})," + ",e.jsx(M,{children:"z"})]}),e.jsx(I,{children:l("header.settings.shortcuts.undo")})]}),e.jsxs(q,{children:[e.jsx(I,{children:Se?e.jsxs(e.Fragment,{children:[e.jsx(M,{sx:ge,children:"⇧"})," + ",e.jsx(M,{sx:ge,children:"⌘"})," + ",e.jsx(M,{children:"z"})]}):e.jsxs(e.Fragment,{children:[e.jsx(M,{children:"ctrl"})," + ",e.jsx(M,{children:"y"})]})}),e.jsx(I,{children:l("header.settings.shortcuts.redo")})]})]})]})})]}),e.jsxs(_,{width:"100%",mb:"3",children:[e.jsx(f,{as:"b",fontSize:"xl",children:l("header.settings.telemetry.title")}),e.jsxs(_,{mt:"3",children:[e.jsx(f,{fontSize:"sm",lineHeight:"100%",color:"gray.600",children:l("header.settings.telemetry.info")}),e.jsxs(_,{mt:"3",mb:"1",children:[e.jsxs(_,{display:"flex",mb:"1",children:[e.jsx(f,{flex:"1",children:l("header.settings.telemetry.essential")}),e.jsx(Ee,{label:l("header.settings.telemetry.essentialTooltip"),children:e.jsx(De,{isChecked:je,isDisabled:!0})})]}),e.jsx(f,{fontSize:"sm",lineHeight:"100%",color:"gray.600",children:l("header.settings.telemetry.essentialInfo")}),e.jsxs(L,{color:g,fontSize:"sm",lineHeight:"100%",href:"https://support.google.com/analytics/answer/11593727",isExternal:!0,children:[l("header.settings.telemetry.essentialLink")," ",e.jsx(U,{as:W})]})]}),e.jsxs(_,{mt:"1",mb:"1",children:[e.jsxs(_,{display:"flex",children:[e.jsx(f,{flex:"1",children:l("header.settings.telemetry.additional")}),e.jsx(De,{isChecked:o,onChange:({target:{checked:R}})=>$e(R)})]}),e.jsx(f,{fontSize:"sm",lineHeight:"100%",color:"gray.600",children:l("header.settings.telemetry.additionalInfo")})]})]})]})]})})]})]})},Do=()=>{const[t,r]=x.useState(!1),{svgViewBoxZoom:a}=G(n=>n.param),s=F(),o=[{type:"slider",label:"",value:400-a,min:10,max:390,step:1,onChange:n=>s(Ge(400-n)),leftIcon:e.jsx(Cn,{}),rightIcon:e.jsx(Qt,{}),minW:160}];return e.jsxs(cs,{isOpen:t,onOpen:()=>r(!0),onClose:()=>r(!1),children:[e.jsx(ds,{children:e.jsx(le,{"aria-label":"zoom",variant:"ghost",size:"sm",icon:e.jsx(Qt,{}),onClick:()=>r(!t)})}),e.jsx(hs,{children:e.jsx(ps,{children:e.jsx(Ne,{fields:o,noLabel:!0})})})]})};function Bo(){const{t}=H(),r=F(),{past:a,future:s}=G(m=>m.param),o=E.isAllowAnalytics(),[n,i]=x.useState(!1),[c,d]=x.useState(!1),u=es(E.getEnv),b=es(E.getAppVersion),h=vn();x.useEffect(()=>{o&&u!==ft.DEV&&E.event(Ie.APP_LOAD,{isStandaloneWindow:E.isStandaloneWindow()})},[u]);const l=m=>{E.getI18nInstance().changeLanguage(m)},g=()=>{r(Rn()),r(Q()),r(K())},p=()=>{r(Nn()),r(Q()),r(K())};return e.jsxs(An,{children:[e.jsxs(Ct,{direction:h==="landscape"?"row":"column",width:"100%",children:[e.jsxs(Ot,{height:"32px",children:[e.jsx(Be,{as:"h4",size:"md",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",children:t("header.about.rmp")}),e.jsx(On,{environment:u,version:b,popoverHeader:u===ft.PRD?void 0:e.jsxs(Mt,{i18nKey:"header.popoverHeader",environment:u,children:["You're on ",{environment:u}," environment!"]}),popoverBody:u===ft.PRD?void 0:e.jsx(Mt,{i18nKey:"header.popoverBody",children:"This is a testing environment where we test the latest beta RMP."})})]}),e.jsxs(Ot,{overflowX:"auto",ml:h==="landscape"?"auto":void 0,children:[e.jsx(fo,{}),e.jsx(le,{size:"sm",variant:"ghost","aria-label":"Undo",icon:e.jsx(Tn,{}),isDisabled:a.length===0,onClick:g}),e.jsx(le,{size:"sm",variant:"ghost","aria-label":"Redo",icon:e.jsx(_n,{}),isDisabled:s.length===0,onClick:p}),e.jsx(Do,{}),e.jsx(mo,{}),e.jsx(ro,{}),E.isStandaloneWindow()&&e.jsxs(Pt,{children:[e.jsx(Dt,{as:le,icon:e.jsx(kn,{}),variant:"ghost",size:"sm"}),e.jsx(Bt,{children:["en","zh-Hans","zh-Hant","ja","ko"].map(m=>e.jsx(xe,{onClick:()=>l(m),children:Mn[m][m]},m))})]}),e.jsx(le,{size:"sm",variant:"ghost","aria-label":"Settings",icon:e.jsx(zn,{}),onClick:()=>i(!0)}),e.jsx(le,{size:"sm",variant:"ghost","aria-label":"Help",icon:e.jsx(En,{}),onClick:()=>d(!0)})]})]}),e.jsx(Po,{isOpen:n,onClose:()=>i(!1)}),e.jsx(Wn,{isOpen:c,onClose:()=>d(!1)})]})}function Wo(){const t=F(),r=G(s=>s.runtime.globalAlerts),a=s=>{E.isStandaloneWindow()?window.open("/".concat(s),"_blank"):E.openApp({appId:s})};return e.jsx(e.Fragment,{children:Object.entries(r).map(([s,{message:o,url:n,linkedApp:i}])=>e.jsxs(vt,{status:s,variant:"solid",size:"xs",pl:3,pr:1,py:0,zIndex:"1",children:[e.jsx(At,{}),i?e.jsx(L,{onClick:()=>a(i),children:o}):n?e.jsx(L,{href:n,target:"_blank",children:o}):o,e.jsx(ls,{ml:"auto",onClick:()=>t(In(s))})]},s))})}function Vo(){return e.jsxs(e.Fragment,{children:[e.jsx(Bo,{}),e.jsx(Wo,{})]})}export{Vo as default};
