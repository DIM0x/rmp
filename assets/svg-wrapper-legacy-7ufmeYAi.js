System.register(["./chakra-legacy-DU5vZKuW.js","./index-legacy-Cs4gHlmc.js","./master-manager-legacy-DXyvp0Y3.js","./react-legacy-Dg_9iw_u.js","./useEvent-legacy-CC7d89T5.js","./misc-nodes-legacy-CAPXW-lN.js"],function(e,t){"use strict";var n,s,r,o,i,a,c,d,l,h,u,y,g,x,p,f,m,v,b,w,j,A,P,k,$,M,S,z,N,_,E,D,W,C,I,H,O,L,T,B,R,X,K,Y,U,V,F,q,Z,J,Q,G,ee,te,ne,se,re;return{setters:[e=>{n=e.ac,s=e.j},e=>{r=e.n,o=e.ay,i=e.T,a=e.aA,c=e.aB,d=e.a8,l=e.e,h=e.aC,u=e.aD,y=e.L,g=e.q,x=e.aE,p=e.aF,f=e.aG,m=e.Z,v=e.c,b=e.t,w=e.v,j=e.aH,A=e.aI,P=e.X,k=e.aJ,$=e.aK,M=e.o,S=e.p,z=e.r,N=e.E,_=e.x,E=e.y,D=e.D,W=e.Y,C=e.aL,I=e.aM,H=e.S,O=e.w,L=e.aN,T=e.a5,B=e.aO,R=e.ag,X=e.G,K=e.av,Y=e.aw,U=e.F,V=e.aP,F=e.d,q=e.a6},e=>{Z=e.s,J=e.b,Q=e.g,G=e.i,ee=e.c},e=>{te=e.j,ne=e.d},e=>{se=e.u},e=>{re=e.m}],execute:function(){const t={[d.Shmetro]:[{"zh-Hans":"安徽南路",en:"South Anhui Road"},{"zh-Hans":"广西西路",en:"West Guangxi Road"},{"zh-Hans":"西藏东路",en:"East Xizang Road"},{"zh-Hans":"湖北北路",en:"North Hubei Road"},{"zh-Hans":"吉林中路",en:"Central Jilin Road"},{"zh-Hans":"乌镇大道",en:"Wuzhen Avenue"},{"zh-Hans":"龙溪公路",en:"Longxi Highway"},{"zh-Hans":"抚顺公园",en:"Fushun Park"},{"zh-Hans":"七星新城",en:"Qixing New Town"},{"zh-Hans":"千灯机场",en:"Qiandeng Airport"},{"zh-Hans":"震泽",en:"Zhengze"},{"zh-Hans":"沧浪高科园区",en:"Canglang High-Tech Park"},{"zh-Hans":"黎里",en:"Lili"},{"zh-Hans":"娄塘新村",en:"Loutang Xincun"},{"zh-Hans":"建设新村",en:"Jianshe Xincun"}],[d.Bjsubway]:[{"zh-Hans":"青松路",en:"Qingsonglu"},{"zh-Hans":"星海广场",en:"Xinghai Guangchang"},{"zh-Hans":"科技新城",en:"Keji Xincheng"},{"zh-Hans":"东湖桥",en:"Donghuqiao"},{"zh-Hans":"金融中心南",en:"Jinrongzhongxinnan"},{"zh-Hans":"玉泉东路",en:"Yuquan Donglu"},{"zh-Hans":"西山北街",en:"Xishan Beijie"},{"zh-Hans":"天光西门",en:"Tianguangximen"},{"zh-Hans":"翠竹园",en:"Cuizhuyuan"},{"zh-Hans":"明月港",en:"Mingyuegang"},{"zh-Hans":"春华街",en:"Chunhuajie"},{"zh-Hans":"锦绣大道",en:"Jinxiu Dadao"}]},oe=te("runtime/getStationNames",async({cityName:e},{getState:t,dispatch:n,rejectWithValue:s})=>{const{token:r}=t().account;if(!r)return void n(a({cityName:e,names:[]}));const o=await fetch(`${c}/${e}`,{headers:{accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${r}`}});if(!o.ok)return i.warn("Failed to fetch random station names",o.statusText),s(o.statusText);const d=await o.json();n(a({cityName:e,names:d}))}),ie=te("runtime/getOneStationName",async(e,{getState:n,dispatch:s})=>{const{stationNames:r}=n().runtime,o=r[e];if(0==(o?.length??0))return i.debug("No random station names in cache, using fallback"),s(oe({cityName:e})),Object.values((e=>{const n=t[e];return n.at(Math.floor(Math.random()*n.length))})(e));const c=structuredClone(o),d=c.shift();return s(a({cityName:e,names:c})),c.length<3&&s(oe({cityName:e})),Object.values(d)}),ae=ne.memo(e=>{const{svgViewBoxMin:t,svgViewBoxZoom:r,svgWidth:o,svgHeight:i}=e,{preference:{toolsPanel:{expand:a}}}=l(e=>e.app),c="light"===n().colorMode?"#666464":"#D3D3D4",d=h(t,r,o,i),y=a?410*r/100:0,g=r>30?r>120?50:25:5,x=r/200,p={startX:u(d.xMin+y-g,g),endX:u(d.xMax+y+g,g),startY:u(d.yMin-g,g),endY:u(d.yMax+g,g)},f=Array.from({length:(p.endX-p.startX)/g+1},(e,t)=>{const n=p.startX+t*g,r=n%(5*g)==0?2*x:x;return s.jsx("line",{x1:n,y1:p.startY,x2:n,y2:p.endY,strokeWidth:r,stroke:c,opacity:"0.5"},`grid_vl_${n}`)}),m=Array.from({length:(p.endY-p.startY)/g+1},(e,t)=>{const n=p.startY+t*g,r=n%(5*g)==0?2*x:x;return s.jsx("line",{x1:p.startX,y1:n,x2:p.endX,y2:n,strokeWidth:r,stroke:c,opacity:"0.5"},`grid_hl_${n}`)}),v=Array.from({length:(p.endX-p.startX)/g/5+1},(e,t)=>{const n=u(p.startX,5*g)+5*t*g;return s.jsx("text",{x:n,y:d.yMin+r/5,fontSize:25*x,fill:c,textAnchor:"middle",opacity:"0.5",children:n},`grid_vc_${n}`)}),b=Array.from({length:(p.endY-p.startY)/g/5+1},(e,t)=>{const n=u(p.startY,5*g)+5*t*g;return s.jsx("text",{x:d.xMin+r/8+y,y:n,fontSize:25*x,fill:c,textAnchor:"start",opacity:"0.5",children:n},`grid_hc_${n}`)});return s.jsxs("g",{id:"grid-lines",className:"removeMe",children:[f,m,v,b]})},(e,t)=>e.svgViewBoxMin.x===t.svgViewBoxMin.x&&e.svgViewBoxMin.y===t.svgViewBoxMin.y&&e.svgViewBoxZoom===t.svgViewBoxZoom&&e.svgWidth===t.svgWidth&&e.svgHeight===t.svgHeight),ce=(e,t,n,s,r,o)=>{if(!("offsetFrom"in o)||!("offsetTo"in o))return;if(Number.isNaN(o.offsetFrom)||Number.isNaN(o.offsetTo))return;if(o.offsetFrom===o.offsetTo)return le(e,t,n,s,r)?{x1:t,y1:n,x2:s,y2:r,offset:o.offsetFrom}:void 0;const[i,a]=[o.offsetFrom,o.offsetTo];for(let c=0;c<Math.PI;c+=Math.PI/8)for(let o=c,d=0;d<2;d++,o+=Math.PI){const[d,l,h,u]=[Math.sin(c)*i,Math.cos(c)*i,Math.sin(o)*a,Math.cos(o)*a];if(le(e,t+d,n+l,s+h,r+u))return{x1:t+d,y1:n+l,x2:s+h,y2:r+u,offset:0}}},de=(e,t,n,s,r,o)=>e===n?{x1:e+5*o,y1:t,x2:n+5*o,y2:s,offset:r}:t===s?{x1:e,y1:t+5*o,x2:n,y2:s+5*o,offset:r}:{x1:e+5*Math.SQRT1_2*o,y1:t+5*Math.SQRT1_2*o,x2:n+5*Math.SQRT1_2*o,y2:s+5*Math.SQRT1_2*o,offset:r},le=(e,t,n,s,r)=>!(t!==s&&n!==r||![y.Diagonal,y.Perpendicular].includes(e))||!(1!==Math.abs((r-n)/(s-t))||![y.Diagonal,y.RotatePerpendicular].includes(e)),he=(e,t)=>{if(!t.every(t=>e.hasEdge(t)))return;const n=t.map(t=>{const[n,s]=e.extremities(t),r=e.getNodeAttributes(n),o=e.getNodeAttributes(s),{type:i}=e.getEdgeAttributes(t),a=e.getEdgeAttribute(t,i)??g[i].defaultAttrs,c=ce(i,r.x,r.y,o.x,o.y,a);if(c){const{x1:e,y1:t,x2:n,y2:s,offset:r}=c;return g[y.Simple].generatePath(e,n,t,s,{offset:r})}return g[i]?.generatePath(r.x,o.x,r.y,o.y,a)??`M ${r.x} ${r.y} L ${o.x} ${o.y}`});let s=`${n[0]} `;for(let r=1;r<t.length;r+=1)s+=n[r].replace(/M\s*-?\d+(\.\d+)?(\s*|,)-?\d+(\.*\d+)?\s*/i,"");return s},ue=e=>[...e.nodeEntries()].map(e=>e.node.startsWith("stn")?{id:e.node,type:"station",station:e.attributes}:{id:e.node,type:"misc-node",miscNode:e.attributes}),ye=e=>{const t={},n={},s=[],r={},o=[];for(const d of e.edgeEntries()){const[e,t,s,r]=[d.sourceAttributes.x,d.sourceAttributes.y,d.targetAttributes.x,d.targetAttributes.y],o=d.attributes[d.attributes.type],i=ce(d.attributes.type,e,t,s,r,o);n[d.edge]=i}for(const d of e.edgeEntries()){let i=n[d.edge];const{parallelIndex:a}=d.attributes;if(a>=0){const t=n[x(e,d.attributes.type,d.edge)];if(!t){s.push(d);continue}if(a>0){const{x1:e,y1:n,x2:s,y2:r,offset:o}=t;i=de(e,n,s,r,o,a)}}if(""!==d.attributes.reconcileId){const e=d.attributes.reconcileId;e in r?r[e].push(d):r[e]=[d];continue}if(i){const e=d.edge,n=d.attributes,{x1:s,y1:r,x2:o,y2:a,offset:c}=i;t[e]={attr:n,path:g[y.Simple].generatePath(s,o,r,a,{offset:c})};continue}o.push(d)}const i=new Set;for(;s.length;){const n=s.pop();if(i.has(n.edge))continue;const{parallel:r}=p(e,n);if(!r.length)continue;r.forEach(e=>i.add(e.edge));const o=f(r);for(const e of r){const n=e.edge;t[n]={attr:e.attributes,path:o[n]}}}const{allReconciledLines:a,danglingLines:c}=((e,t)=>{const n=[],s=[];return Object.values(t).forEach(t=>{if(1===t.length)return void s.push(...t.map(e=>e.edge));const r=e.getEdgeAttribute(t.at(0),"type");if(!t.every(t=>e.getEdgeAttribute(t,"type")===r))return void s.push(...t.map(e=>e.edge));const o=e.getEdgeAttribute(t.at(0),"style");if(!t.every(t=>e.getEdgeAttribute(t,"style")===o))return void s.push(...t.map(e=>e.edge));const i={},a=new Set,c=new Set,d=Object.fromEntries(t.map(t=>{const[n,s]=e.extremities(t);return i[n]=(i[n]??0)+1,i[s]=(i[s]??0)+1,a.add(n),c.add(s),[n,[t.edge,s]]})),l=Array.from(a).filter(e=>1===i[e]),h=Array.from(c).filter(e=>1===i[e]);if(1!==l.length||1!==h.length)return void s.push(...t.map(e=>e.edge));const u=l[0],y=h[0];if(u===y)return void s.push(...t.map(e=>e.edge));const g=[d[u][0]];let x=d[u][1];for(let e=1;e<t.length;e+=1){const e=d[x]?.at(1);if(!e)return void s.push(...t.map(e=>e.edge));g.push(d[x][0]),x=e}x===y&&g.length===t.length?n.push(g):s.push(...t.map(e=>e.edge))}),{allReconciledLines:n,danglingLines:s}})(e,r);for(const d of a){const n=he(e,d);if(!n)continue;const s=d[0];t[s]={attr:e.getEdgeAttributes(s),path:n}}for(const d of c){const n=e.getEdgeAttributes(d),[s,r]=e.extremities(d),o=e.getNodeAttributes(s),i=e.getNodeAttributes(r);t[d]={attr:n,path:g[y.Simple].generatePath(o.x,i.x,o.y,i.y,g[y.Simple].defaultAttrs)}}for(const d of o){const e=d.edge,n=d.attributes.type,s=d.attributes,[r,o,i,a]=[d.sourceAttributes.x,d.sourceAttributes.y,d.targetAttributes.x,d.targetAttributes.y];t[e]=n in g?{attr:s,path:g[n].generatePath(r,i,o,a,s[n])}:{attr:s,path:`M ${r} ${o} L ${i} ${a}`}}return Object.entries(t).map(([e,t])=>({id:e,type:"line",line:t}))},ge=e=>{const{id:t,x:n,y:r,handlePointerDown:o,handlePointerMove:i,handlePointerUp:a}=e,c=ne.useCallback(e=>o(t,e),[t,o]),d=ne.useCallback(e=>i(t,e),[t,i]),l=ne.useCallback(e=>a(t,e),[t,a]);return s.jsx("g",{id:t,transform:`translate(${n-6.4} ${r-6.4})scale(0.025)`,onPointerDown:c,onPointerMove:d,onPointerUp:l,style:{cursor:"move"},children:s.jsx("path",{id:`stn_core_${t}`,fillRule:"evenodd",clipRule:"evenodd",d:"M256 0c70.69 0 134.7 28.66 181.02 74.98C483.34 121.31 512 185.31 512 256c0 70.69-28.66 134.7-74.98 181.02C390.7 483.34 326.69 512 256 512c-70.69 0-134.69-28.66-181.02-74.98C28.66 390.7 0 326.69 0 256c0-70.69 28.66-134.69 74.98-181.02C121.31 28.66 185.31 0 256 0zm-21.91 302.69v-2.07c.16-13.72 1.51-24.59 4.15-32.67 2.59-8.08 6.32-14.65 11.18-19.63 4.87-5.02 10.72-9.58 17.56-13.72 4.4-2.8 8.39-5.9 11.91-9.37 3.52-3.42 6.32-7.41 8.38-11.91 2.07-4.46 3.11-9.42 3.11-14.91 0-6.53-1.55-12.18-4.66-16.99-3.05-4.77-7.19-8.44-12.27-11.08-5.13-2.59-10.82-3.89-17.09-3.89-5.65 0-11.03 1.15-16.21 3.53-5.12 2.33-9.42 6-12.79 10.97-3.36 4.98-5.33 11.35-5.85 19.11h-33.56c.53-13.21 3.89-24.39 10.05-33.55 6.21-9.16 14.4-16.11 24.55-20.82 10.2-4.71 21.49-7.04 33.81-7.04 13.57 0 25.38 2.48 35.52 7.56 10.15 5.02 18.08 12.06 23.72 21.08 5.59 9 8.44 19.47 8.44 31.48 0 8.23-1.29 15.64-3.88 22.21-2.59 6.58-6.22 12.48-10.98 17.61-4.77 5.18-10.41 9.73-17.03 13.67-6.27 3.94-11.35 7.97-15.18 12.17-3.88 4.19-6.68 9.17-8.44 14.86-1.76 5.74-2.75 12.84-2.9 21.33v2.07h-31.54zm16.68 70.67c-6.06 0-11.24-2.18-15.59-6.48-4.34-4.29-6.47-9.53-6.47-15.63 0-6.01 2.12-11.19 6.47-15.49 4.35-4.3 9.53-6.47 15.59-6.47 5.95 0 11.12 2.19 15.48 6.47 4.39 4.31 6.58 9.48 6.58 15.49 0 4.04-1.05 7.76-3.06 11.08-2.02 3.35-4.66 6.07-7.97 8.03-3.31 1.96-6.99 3-11.03 3z"})})},xe=e=>{const{id:t,path:n,handlePointerDown:r}=e,o=ne.useCallback(e=>r(t,e),[t,r]);return s.jsx("path",{id:t,d:n,fill:"none",stroke:"grey",strokeWidth:"5",strokeLinecap:"round",cursor:"pointer",onPointerDown:o})},pe=ne.memo(e=>{const{elements:t,handlePointerDown:n,handlePointerMove:r,handlePointerUp:o,handleEdgePointerDown:i}=e,a=Object.fromEntries(Array.from({length:21},(e,t)=>[t-10,{pre:[],main:[],post:[]}]));for(const c of t)if("line"===c.type){const e=c.line.attr.type,t=c.line.attr.style,n=c.line.attr[t],r=m[t]?.preComponent;r&&a[c.line.attr.zIndex].pre.push(s.jsx(r,{id:c.id,type:e,path:c.line.path,styleAttrs:n,newLine:!1,handlePointerDown:i},`${c.id}.pre`));const o=m[t]?.component??xe;a[c.line.attr.zIndex].main.push(s.jsx(o,{id:c.id,type:e,path:c.line.path,styleAttrs:n,newLine:!1,handlePointerDown:i},c.id));const d=m[t]?.postComponent;d&&a[c.line.attr.zIndex].post.push(s.jsx(d,{id:c.id,type:e,path:c.line.path,styleAttrs:n,newLine:!1,handlePointerDown:i},`${c.id}.post`))}else if("station"===c.type){const e=c.station,t=e.type,i=Z[t]?.preComponent;i&&a[c.station.zIndex].pre.push(s.jsx(i,{id:c.id,x:e.x,y:e.y,attrs:e,handlePointerDown:n,handlePointerMove:r,handlePointerUp:o},`${c.id}.pre`));const d=Z[t]?.component??ge;a[c.station.zIndex].main.push(s.jsx(d,{id:c.id,x:e.x,y:e.y,attrs:e,handlePointerDown:n,handlePointerMove:r,handlePointerUp:o},c.id));const l=Z[t]?.postComponent;l&&a[c.station.zIndex].post.push(s.jsx(l,{id:c.id,x:e.x,y:e.y,attrs:e,handlePointerDown:n,handlePointerMove:r,handlePointerUp:o},`${c.id}.post`))}else if("misc-node"===c.type){const e=c.miscNode,t=e.type,i=re[t]?.preComponent;i&&a[c.miscNode.zIndex].pre.push(s.jsx(i,{id:c.id,x:e.x,y:e.y,attrs:e[t],handlePointerDown:n,handlePointerMove:r,handlePointerUp:o},`${c.id}.pre`));const d=re[t]?.component??ge;a[c.miscNode.zIndex].main.push(s.jsx(d,{id:c.id,x:e.x,y:e.y,attrs:e[t],handlePointerDown:n,handlePointerMove:r,handlePointerUp:o},c.id));const l=re[t]?.postComponent;l&&a[c.miscNode.zIndex].post.push(s.jsx(l,{id:c.id,x:e.x,y:e.y,attrs:e[t],handlePointerDown:n,handlePointerMove:r,handlePointerUp:o},`${c.id}.post`))}return Array.from({length:21},(e,t)=>(t-10).toString()).map(e=>[...a[e].pre,...a[e].main,...a[e].post]).flat()},(e,t)=>e.elements===t.elements),fe=e=>{const{activeSnapPoint:t}=e,{svgViewBoxZoom:n}=l(e=>e.param),{original:r,offset:o,rotate:i}=(e=>{const t=[{x:e.x,y:e.y},...e.originalNodesPos].sort((e,t)=>e.x===t.x?e.y-t.y:e.x-t.x),n=(t[1].y-t[0].y)/(t[1].x-t[0].x);if(Math.abs(n)<=.01)return{original:t,offset:t.map(e=>({x:e.x,y:e.y+10})),rotate:0};if(Math.abs(n)>=1e10)return{original:t,offset:t.map(e=>({x:e.x+10,y:e.y})),rotate:90};{const e=10,s=-1/n,r=e/Math.sqrt(s*s+1),o=e*s/Math.sqrt(s*s+1);return{original:t,offset:t.map(e=>({x:e.x+r,y:e.y+o})),rotate:-Math.atan(s)*(180/Math.PI)}}})(t),a=e=>{const t=Math.sqrt(3)/2*e;return`0,0 ${-e/2},${t} ${e/2},${t}`},c=n/75,d=8*c,h="#FC8181",u=`${5*c} ${2*c}`;return s.jsxs(s.Fragment,{children:[s.jsx("line",{x1:o[0].x,y1:o[0].y,x2:o[1].x,y2:o[1].y,stroke:h,strokeWidth:c,strokeDasharray:u}),s.jsx("line",{x1:o[1].x,y1:o[1].y,x2:o[2].x,y2:o[2].y,stroke:h,strokeWidth:c,strokeDasharray:u}),s.jsx("line",{x1:r[0].x,y1:r[0].y,x2:o[0].x,y2:o[0].y,stroke:h,strokeWidth:c,strokeDasharray:u}),s.jsx("line",{x1:r[1].x,y1:r[1].y,x2:o[1].x,y2:o[1].y,stroke:h,strokeWidth:c,strokeDasharray:u}),s.jsx("line",{x1:r[2].x,y1:r[2].y,x2:o[2].x,y2:o[2].y,stroke:h,strokeWidth:c,strokeDasharray:u}),s.jsx("polygon",{points:a(d),transform:`translate(${o[0].x},${o[0].y}) rotate(${(i+270)%360})`,fill:h}),s.jsx("polygon",{points:a(d),transform:`translate(${o[1].x},${o[1].y}) rotate(${(i+270)%360})`,fill:h}),s.jsx("polygon",{points:a(d),transform:`translate(${o[1].x},${o[1].y}) rotate(${(i+90)%360})`,fill:h}),s.jsx("polygon",{points:a(d),transform:`translate(${o[2].x},${o[2].y}) rotate(${(i+90)%360})`,fill:h})]})},me=[...Object.values(H),o.Virtual,o.Master,o.LondonArrow,o.ChongqingRTNumLineBadge2021,o.ChongqingRTTextLineBadge2021,o.ChengduRTLineBadge,o.GzmtrLineBadge],ve=()=>{const e=v(),t=ne.useRef(window.graph),{telemetry:{project:n},preference:{autoParallel:o,gridLines:i,snapLines:a}}=l(e=>e.app),{svgViewBoxZoom:c,svgViewBoxMin:d}=l(e=>e.param),{selected:x,refresh:{nodes:p,edges:f},mode:m,active:H,keepLastPath:L,theme:T}=l(e=>e.runtime),B=b(),{height:R,width:X}=w(B),[K,Y]=ne.useState(),[U,V]=ne.useState({dx:0,dy:0}),[F,q]=ne.useState([]),[G,ee]=ne.useState([]),[te,oe]=ne.useState([]);ne.useEffect(()=>{if(K&&a)return;const e=h(d,c,X,R),n=J(t.current,...Object.values(e));ee(n),q(Q(t.current,n))},[d,c,X,R,K]);const[ie,ae]=ne.useState(void 0),ce=se((t,n)=>{n.stopPropagation(),"select"===m&&e(j("free"));const s=n.currentTarget;A(n),s.setPointerCapture(n.pointerId),oe([]),ae(void 0),n.shiftKey?x.has(t)?e(k(t)):e($(t)):x.has(t)||e(P(new Set([t])))}),de=se((e,t)=>{const{x:n,y:s}=A(t);m.startsWith("line")&&V({dx:(K.x-n)*c/100,dy:(K.y-s)*c/100})}),le=se((s,i)=>{if(m.startsWith("line")){L||e(j("free"));const s=t.current.hasNode(H)&&me.includes(t.current.getNodeAttribute(H,"type"));["stn_core_","virtual_circle_","misc_node_connectable_"].forEach(a=>{const c=document.elementsFromPoint(i.clientX,i.clientY),d=c[0].attributes?.getNamedItem("id")?.value,l=d?.startsWith(a);if(s&&l){const s=m.slice(5),i=`line_${r(10)}`,[c,l]=[H,d.slice(a.length)],h=o?M(t.current,s,c,l,"from"):-1;t.current.addDirectedEdgeWithKey(i,c,l,{visible:!0,zIndex:0,type:s,[s]:structuredClone(g[s].defaultAttrs),style:S.SingleColor,[S.SingleColor]:{color:T},reconcileId:"",parallelIndex:h}),e(P(new Set([i]))),n&&z.event(N.ADD_LINE,{type:s})}}),e(_()),e(E(t.current.export()))}oe([]),ae(void 0),Y(void 0)}),he=se((s,i)=>{if(i.stopPropagation(),i.shiftKey||e(D()),i.shiftKey&&x.has(s)?e(k(s)):e($(s)),m.startsWith("station")||m.startsWith("misc-node-virtual")||m.startsWith("misc-node-master")){const a=i.clientX-document.getElementById("canvas").getBoundingClientRect().left,l=i.clientY-document.getElementById("canvas").getBoundingClientRect().top,h=m.startsWith("station"),y=r(10),g=h?`stn_${y}`:`misc_node_${y}`,x=h?m.slice(8):m.slice(10),{x:p,y:f}=W(a,l,c,d),v=h?structuredClone(Z[x].defaultAttrs):structuredClone(re[x].defaultAttrs);"color"in v&&(v.color=T),t.current.addNode(g,{visible:!0,zIndex:0,x:u(p,5),y:u(f,5),type:x,[x]:v});const b=t.current.getEdgeAttributes(s),{zIndex:w,type:A,style:k}=b,$=b[A],M=b[k],[S,D]=t.current.extremities(s),C=o?0:-1;t.current.addDirectedEdgeWithKey(`line_${r(10)}`,S,g,{visible:!0,zIndex:w,type:A,[A]:structuredClone($),style:k,[k]:structuredClone(M),reconcileId:"",parallelIndex:C}),t.current.addDirectedEdgeWithKey(`line_${r(10)}`,g,D,{visible:!0,zIndex:w,type:A,[A]:structuredClone($),style:k,[k]:structuredClone(M),reconcileId:"",parallelIndex:C}),t.current.dropEdge(s),e(O()),e(_()),e(E(t.current.export())),n&&(z.event(N.ADD_STATION,{type:x}),z.event(N.ADD_LINE,{type:A})),e(j("free")),e(P(new Set([g])))}}),ge=ne.useMemo(()=>[...ye(t.current),...ue(t.current)],[f,p]),xe=C.component;return s.jsxs(s.Fragment,{children:[s.jsx(pe,{elements:ge,handlePointerDown:ce,handlePointerMove:de,handlePointerUp:le,handleEdgePointerDown:he}),"/*",m.startsWith("line")&&H&&"background"!==H&&s.jsx(xe,{id:"line_create_in_progress___no_use",type:m.slice(5),path:g[m.slice(5)].generatePath(t.current.getNodeAttribute(H,"x"),t.current.getNodeAttribute(H,"x")-U.dx,t.current.getNodeAttribute(H,"y"),t.current.getNodeAttribute(H,"y")-U.dy,g[m.slice(5)].defaultAttrs),styleAttrs:{color:T},newLine:!0,handlePointerDown:()=>{}}),0!==te.length&&te.map(e=>s.jsx("path",{d:g[y.Simple].generatePath(...I(e,h(d,c,X,R)),g[y.Simple].defaultAttrs),stroke:"cyan",strokeWidth:c/75},`snap_line_${e.a}_${e.b}_${e.c}_${e.node}`)),"*/",ie&&s.jsx(fe,{activeSnapPoint:ie})]})};e("default",()=>{const e=v(),t=ne.useRef(window.graph),n=()=>{e(O()),e(_()),e(E(t.current.export()))},{activeSubscriptions:i}=l(e=>e.account),{telemetry:{project:a},preference:{randomStationsNames:c,gridLines:h}}=l(e=>e.app),{svgViewBoxZoom:y,svgViewBoxMin:g}=l(e=>e.param),{mode:x,lastTool:p,active:f,selected:m,keepLastPath:k,theme:$,refresh:{nodes:M},count:{masters:S,lines:C}}=l(e=>e.runtime),I=b(),{height:H,width:Q}=w(I),te=!i.RMP_CLOUD&&S+1>L,oe=!i.RMP_CLOUD&&C+1>T,ce=!i.RMP_CLOUD||"none"===c;B();const[de,le]=ne.useState({x:0,y:0}),[he,ue]=ne.useState({x:0,y:0}),[ye,ge]=ne.useState({x:0,y:0}),[xe,pe]=ne.useState({x:0,y:0}),fe=se(async s=>{const{x:o,y:i}=A(s);if(x.startsWith("station")||x.startsWith("misc-node")){e(j("free"));const s=r(10),{x:c,y:l}=W(o,i,y,g),h=x.startsWith("station"),p=h?`stn_${s}`:`misc_node_${s}`,f=h?x.slice(8):x.slice(10),m=structuredClone({...Z,...re}[f].defaultAttrs);if(F.has(f)&&(m.color=$),h&&!ce){const t=m.names,n=await e(ie(d.Shmetro));if(ie.fulfilled.match(n)){const e=n.payload;t.length>e.length?e.push(...Array(t.length-e.length).fill(e.at(-1))):t.length<e.length&&e.splice(t.length,e.length-t.length),m.names=e}}t.current.addNode(p,{visible:!0,zIndex:0,x:u(c,5),y:u(l,5),type:f,[f]:m}),n(),a&&z.event(N.ADD_STATION,{type:f}),e(P(new Set([p])))}else"free"===x||x.startsWith("line")?(x.startsWith("line")&&(e(j("free")),k&&e(q(!1))),ge({x:o,y:i}),pe(g),s.shiftKey||(e(V("background")),e(D()))):"select"===x&&(le(W(o,i,y,g)),ue(W(o,i,y,g)))}),me=se(t=>{if("select"===x){if(0!=de.x&&0!=de.y){const{x:e,y:n}=A(t);ue(W(e,n,y,g))}}else if("background"===f){const{x:n,y:s}=A(t);e(X({x:xe.x+(ye.x-n)*y/100,y:xe.y+(ye.y-s)*y/100}))}}),be=se(n=>{if("select"===x){const{x:s,y:r}=A(n),{x:o,y:i}=W(s,r,y,g),a=J(t.current,de.x,de.y,o,i),c=ee(t.current,new Set(a));e(P(new Set([...n.shiftKey?m:[],...a,...c]))),e(j("free")),le({x:0,y:0}),ue({x:0,y:0})}"background"!==f||n.shiftKey||e(V(void 0))}),we=se(t=>{let n=y;t.deltaY>0&&y+10<400?n=y+10:t.deltaY<0&&y-10>0&&(n=y-10),e(U(n));const{x:s,y:r}=A(t),o=t.currentTarget.getBoundingClientRect(),[i,a]=[s/o.width,r/o.height];e(X({x:g.x+s*y/100-Q*n/100*i,y:g.y+r*y/100-H*n/100*a}))}),je=se(async s=>{if(R?"Backspace"===s.key:"Delete"===s.key)m.size>0&&(m.forEach(e=>{t.current.hasNode(e)?t.current.dropNode(e):t.current.hasEdge(e)&&t.current.dropEdge(e)}),e(D()),n());else if(s.key.startsWith("Arrow")){const t=100,n=s.key.endsWith("Left")?-1:s.key.endsWith("Right")?1:0,r=s.key.endsWith("Up")?-1:s.key.endsWith("Down")?1:0;e(X(W(t*n,t*r,y,g)))}else if("z"===s.key&&(R?s.metaKey&&!s.shiftKey:s.ctrlKey))R&&s.preventDefault(),e(K()),e(O()),e(_());else if("s"===s.key)e(j("select"));else if("c"!==s.key&&"x"!==s.key||!(R?s.metaKey&&!s.shiftKey:s.ctrlKey))if("v"===s.key&&(R?s.metaKey&&!s.shiftKey:s.ctrlKey)){const s=await navigator.clipboard.readText(),{x:i,y:a}=W(Q/2,H/2,y,g),{nodes:c,edges:d}=((e,t,n,s,i,a)=>{const{nodesWithAttrs:c,edgesWithAttrs:d,version:l}=JSON.parse(e);if(1!==l)throw Error(`Unrecognized version: ${l}`);const h={};Object.keys(c).filter(e=>t.hasNode(e)).forEach(e=>{const t=r(10);if(e.startsWith("stn_"))h[e]=`stn_${t}`;else{if(!e.startsWith("misc_node_"))throw Error(`Unrecognized node id: ${e}`);h[e]=`misc_node_${t}`}}),Object.keys(d).filter(e=>t.hasEdge(e)).forEach(e=>h[e]=`line_${r(10)}`);const u=Object.entries(h).reduce((e,[t,n])=>e.replaceAll(t,n),e),{nodesWithAttrs:y,edgesWithAttrs:g,avgX:x,avgY:p}=JSON.parse(u),f=n?Object.fromEntries(Object.entries(y).filter(([e,t])=>t.type!==o.Master)):y,m=n?Object.fromEntries(Object.entries(g).filter(([e,{source:t,target:n}])=>t in f&&n in f)):g;if(s)for(const r in m)m[r].attr.parallelIndex>=0&&(m[r].attr.parallelIndex=-1);const[v,b]=[i-x,a-p];return Object.entries(f).forEach(([e,n])=>{n.x+=v,n.y+=b,t.addNode(e,n)}),Object.entries(m).forEach(([e,{attr:n,source:s,target:r}])=>t.addDirectedEdgeWithKey(e,s,r,n)),{nodes:new Set(Object.keys(f)),edges:new Set(Object.keys(m))}})(s,t.current,te,oe,u(i,5),u(a,5));n();const l=structuredClone(c);d.forEach(e=>l.add(e)),e(P(l))}else(R&&"z"===s.key&&s.metaKey&&s.shiftKey||!R&&"y"===s.key&&s.ctrlKey)&&(e(Y()),e(O()),e(_()));else{const r=((e,t)=>{const n={},s={};let[r,o]=[0,0],i=0;t.forEach(t=>{if(e.hasNode(t)){const s=t,a=e.getNodeAttributes(s);n[s]=a,r+=a.x,o+=a.y,i++}else if(e.hasEdge(t)){const n=t,[r,o]=e.extremities(n);s[n]={attr:e.getEdgeAttributes(n),source:r,target:o}}});const a={app:"rmp",version:1,nodesWithAttrs:n,edgesWithAttrs:s,avgX:r/i,avgY:o/i};return JSON.stringify(a)})(t.current,m);navigator.clipboard.writeText(r),"x"===s.key&&(e(D()),m.forEach(e=>{t.current.hasNode(e)?t.current.dropNode(e):t.current.hasEdge(e)&&t.current.dropEdge(e)}),n())}}),[Ae,Pe]=ne.useState(0),ke=se(t=>{if(2===t.touches.length){e(V(void 0));const[n,s]=[t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY];Pe(n*n+s*s)}}),$e=se(t=>{if(0!==Ae&&2===t.touches.length){const[n,s]=[t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY],r=n*n+s*s;let o=y;r-Ae<0&&y+10<=390?o=y+10:r-Ae>0&&y-10>=10&&(o=y-10),e(U(o)),Pe(r);const i=t.currentTarget.getBoundingClientRect(),[a,c]=[(t.touches[0].clientX+t.touches[1].clientX)/2-i.left,(t.touches[0].clientY+t.touches[1].clientY)/2-i.top],[d,l]=[a/i.width,c/i.height];e(X({x:g.x+a*y/100-Q*o/100*d,y:g.y+c*y/100-H*o/100*l}))}}),Me=se(e=>{0!==Ae&&Pe(0)}),[Se,ze]=ne.useState({sx:0,sy:0,ex:0,ey:0});return ne.useEffect(()=>{ze({sx:de.x<=he.x?de.x:he.x,ex:de.x>he.x?de.x:he.x,sy:de.y<=he.y?de.y:he.y,ey:de.y>he.y?de.y:he.y})},[he.x,he.y]),s.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",id:"canvas",style:{position:"fixed",top:40,userSelect:"none",touchAction:"none"},height:H,width:Q,viewBox:`${g.x} ${g.y} ${Q*y/100} ${H*y/100}`,onPointerDown:fe,onPointerMove:me,onPointerUp:be,onTouchStart:ke,onTouchMove:$e,onTouchEnd:Me,onWheel:we,tabIndex:0,onKeyDown:je,children:[h&&s.jsx(ae,{svgViewBoxMin:g,svgViewBoxZoom:y,svgWidth:Q,svgHeight:H}),s.jsx(G.SvgAssetsContextProvider,{children:s.jsx(ve,{})}),"select"===x&&0!=de.x&&0!=de.y&&s.jsx("rect",{x:Se.sx,y:Se.sy,width:Se.ex-Se.sx,height:Se.ey-Se.sy,rx:"2",stroke:"#b5b5b6",strokeWidth:"2",strokeOpacity:"0.4",fill:"#b5b5b6",opacity:"0.75"}),s.jsx("defs",{children:s.jsxs("pattern",{id:"opaque",width:"5",height:"5",patternUnits:"userSpaceOnUse",children:[s.jsx("rect",{x:"0",y:"0",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"}),s.jsx("rect",{x:"2.5",y:"2.5",width:"2.5",height:"2.5",fill:"black",fillOpacity:"50%"})]})})]})})}}});
